import{b as e}from"./logger-D2dXBhXY.js";import{b as t}from"./math.scalar.functions-DzEGaKm0.js";import{c as n}from"./tools-BmEJizBm.js";const r=4,i=4,a=1,o=2,s=8,c=65536,l=c>>3,u=16,d=14,f=(1<<u)+1,p=1<<d,m=p-1,h=59,g=63,_=2+g-h;var v;(function(e){e[e.NO_COMPRESSION=0]=`NO_COMPRESSION`,e[e.RLE_COMPRESSION=1]=`RLE_COMPRESSION`,e[e.ZIPS_COMPRESSION=2]=`ZIPS_COMPRESSION`,e[e.ZIP_COMPRESSION=3]=`ZIP_COMPRESSION`,e[e.PIZ_COMPRESSION=4]=`PIZ_COMPRESSION`,e[e.PXR24_COMPRESSION=5]=`PXR24_COMPRESSION`})(v||={});var y;(function(e){e[e.INCREASING_Y=0]=`INCREASING_Y`,e[e.DECREASING_Y=1]=`DECREASING_Y`})(y||={});const b=ee();function ee(){let e=new ArrayBuffer(4),t=new Float32Array(e),n=new Uint32Array(e),r=new Uint32Array(512),i=new Uint32Array(512);for(let e=0;e<256;++e){let t=e-127;t<-27?(r[e]=0,r[e|256]=32768,i[e]=24,i[e|256]=24):t<-14?(r[e]=1024>>-t-14,r[e|256]=1024>>-t-14|32768,i[e]=-t-1,i[e|256]=-t-1):t<=15?(r[e]=t+15<<10,r[e|256]=t+15<<10|32768,i[e]=13,i[e|256]=13):t<128?(r[e]=31744,r[e|256]=64512,i[e]=24,i[e|256]=24):(r[e]=31744,r[e|256]=64512,i[e]=13,i[e|256]=13)}let a=new Uint32Array(2048),o=new Uint32Array(64),s=new Uint32Array(64);for(let e=1;e<1024;++e){let t=e<<13,n=0;for(;!(t&8388608);)t<<=1,n-=8388608;t&=-8388609,n+=947912704,a[e]=t|n}for(let e=1024;e<2048;++e)a[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)o[e]=e<<23;o[31]=1199570944,o[32]=2147483648;for(let e=33;e<63;++e)o[e]=2147483648+(e-32<<23);o[63]=3347054592;for(let e=1;e<64;++e)e!==32&&(s[e]=1024);return{floatView:t,uint32View:n,baseTable:r,shiftTable:i,mantissaTable:a,exponentTable:o,offsetTable:s}}function x(e,t){let n=new Uint8Array(e),r=0;for(;n[t.value+r]!=0;)r+=1;let i=new TextDecoder().decode(n.slice(t.value,t.value+r));return t.value=t.value+r+1,i}function S(e,t){let n=e.getInt32(t.value,!0);return t.value+=r,n}function C(e,t){let n=e.getUint32(t.value,!0);return t.value+=r,n}function w(e,t){let n=e.getUint8(t.value);return t.value+=a,n}function T(e,t){let n=e.getUint16(t.value,!0);return t.value+=o,n}function E(e,t){let n=e[t.value];return t.value+=a,n}function te(e,t){let n;return n=`getBigInt64`in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=s,n}function D(e,t){let n=e.getFloat32(t.value,!0);return t.value+=i,n}function ne(e,t){return re(T(e,t))}function re(e){let t=(e&31744)>>10,n=e&1023;return(e>>15?-1:1)*(t?t===31?n?NaN:1/0:2**(t-15)*(1+n/1024):6103515625e-14*(n/1024))}function ie(e){if(Math.abs(e)>65504)throw Error(`Value out of range.Consider using float instead of half-float.`);e=t(e,-65504,65504),b.floatView[0]=e;let n=b.uint32View[0],r=n>>23&511;return b.baseTable[r]+((n&8388607)>>b.shiftTable[r])}function ae(e,t){return ie(D(e,t))}function oe(e,t,n){let r=new TextDecoder().decode(new Uint8Array(e).slice(t.value,t.value+n));return t.value+=n,r}function se(e,t){let n=S(e,t),r=C(e,t);return[n,r]}function ce(e,t){let n=C(e,t),r=C(e,t);return[n,r]}function le(e,t){let n=D(e,t),r=D(e,t);return[n,r]}function ue(e,t){let n=D(e,t),r=D(e,t),i=D(e,t);return[n,r,i]}function de(e,t,n){let r=t.value,i=[];for(;t.value<r+n-1;){let n=x(e.buffer,t),r=S(e,t),a=w(e,t);t.value+=3;let o=S(e,t),s=S(e,t);i.push({name:n,pixelType:r,pLinear:a,xSampling:o,ySampling:s})}return t.value+=1,i}function fe(e,t){let n=D(e,t),r=D(e,t),i=D(e,t),a=D(e,t),o=D(e,t),s=D(e,t),c=D(e,t),l=D(e,t);return{redX:n,redY:r,greenX:i,greenY:a,blueX:o,blueY:s,whiteX:c,whiteY:l}}function O(e,t){return w(e,t)}function k(e,t){let n=S(e,t),r=S(e,t),i=S(e,t),a=S(e,t);return{xMin:n,yMin:r,xMax:i,yMax:a}}function pe(e,t){let n=w(e,t);return y[n]}function me(e,t,n,r){switch(n){case`string`:case`stringvector`:case`iccProfile`:return oe(e.buffer,t,r);case`chlist`:return de(e,t,r);case`chromaticities`:return fe(e,t);case`compression`:return O(e,t);case`box2i`:return k(e,t);case`lineOrder`:return pe(e,t);case`float`:return D(e,t);case`v2f`:return le(e,t);case`v3f`:return ue(e,t);case`int`:return S(e,t);case`rational`:return se(e,t);case`timecode`:return ce(e,t);case`preview`:return t.value+=r,`skipped`;default:t.value+=r;return}}function A(e){for(let t=1;t<e.length;t++){let n=e[t-1]+e[t]-128;e[t]=n}}function j(e,t){let n=0,r=Math.floor((e.length+1)/2),i=0,a=e.length-1;for(;!(i>a||(t[i++]=e[n++],i>a));)t[i++]=e[r++]}const he=20000630;function M(t,n){if(t.getUint32(0,!0)!=he)throw Error(`Incorrect OpenEXR format`);let r=t.getUint8(4),i=t.getUint8(5),a={singleTile:!!(i&2),longName:!!(i&4),deepFormat:!!(i&8),multiPart:!!(i&16)};n.value=8;let o={},s=!0;for(;s;){let r=x(t.buffer,n);if(!r)s=!1;else{let i=x(t.buffer,n),a=C(t,n),s=me(t,n,i,a);s===void 0?e.Warn(`Unknown header attribute type ${i}'.`):o[r]=s}}if(i&-5)throw Error(`Unsupported file format`);return{version:r,spec:a,...o}}const N=16,ge=1<<N-1,P=(1<<N)-1;function F(e,t){let n=0;for(let r=0;r<c;++r)(r==0||e[r>>3]&1<<(r&7))&&(t[n++]=r);let r=n-1;for(;n<c;)t[n++]=0;return r}function I(e){for(let t=0;t<p;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}function L(e,t,n,r,i){for(;n<e;)t=t<<8|E(r,i),n+=8;return n-=e,{l:t>>n&(1<<e)-1,c:t,lc:n}}function R(e,t,n,r){return e=e<<8|E(n,r),t+=8,{c:e,lc:t}}function z(e,t,n,r,i,a,o,s,c){if(e==t){if(r<8){let e=R(n,r,i,a);n=e.c,r=e.lc}r-=8;let e=n>>r;if(e=new Uint8Array([e])[0],s.value+e>c)return null;let t=o[s.value-1];for(;e-- >0;)o[s.value++]=t}else if(s.value<c)o[s.value++]=e;else return null;return{c:n,lc:r}}const B=Array(59);function _e(e){for(let e=0;e<=58;++e)B[e]=0;for(let t=0;t<f;++t)B[e[t]]+=1;let t=0;for(let e=58;e>0;--e){let n=t+B[e]>>1;B[e]=t,t=n}for(let t=0;t<f;++t){let n=e[t];n>0&&(e[t]=n|B[n]++<<6)}}function V(e,t,n,r,i,a){let o=t,s=0,c=0;for(;r<=i;r++){if(o.value-t.value>n)return;let l=L(6,s,c,e,o),u=l.l;if(s=l.c,c=l.lc,a[r]=u,u==g){if(o.value-t.value>n)throw Error(`Error in HufUnpackEncTable`);l=L(8,s,c,e,o);let u=l.l+_;if(s=l.c,c=l.lc,r+u>i+1)throw Error(`Error in HufUnpackEncTable`);for(;u--;)a[r++]=0;r--}else if(u>=h){let e=u-h+2;if(r+e>i+1)throw Error(`Error in HufUnpackEncTable`);for(;e--;)a[r++]=0;r--}}_e(a)}function H(e){return e&63}function U(e){return e>>6}function ve(e,t,n,r){for(;t<=n;t++){let n=U(e[t]),i=H(e[t]);if(n>>i)throw Error(`Invalid table entry`);if(i>d){let e=r[n>>i-d];if(e.len)throw Error(`Invalid table entry`);if(e.lit++,e.p){let t=e.p;e.p=Array(e.lit);for(let n=0;n<e.lit-1;++n)e.p[n]=t[n]}else e.p=[,];e.p[e.lit-1]=t}else if(i){let e=0;for(let a=1<<d-i;a>0;a--){let a=r[(n<<d-i)+e];if(a.len||a.p)throw Error(`Invalid table entry`);a.len=i,a.lit=t,e++}}}return!0}function ye(e,t,n,r,i,a,o,s,c){let l=0,u=0,f=o,p=Math.trunc(r.value+(i+7)/8);for(;r.value<p;){let i=R(l,u,n,r);for(l=i.c,u=i.lc;u>=d;){let o=l>>u-d&m,h=t[o];if(h.len){u-=h.len;let e=z(h.lit,a,l,u,n,r,s,c,f);e&&(l=e.c,u=e.lc)}else{if(!h.p)throw Error(`hufDecode issues`);let t;for(t=0;t<h.lit;t++){let o=H(e[h.p[t]]);for(;u<o&&r.value<p;)i=R(l,u,n,r),l=i.c,u=i.lc;if(u>=o&&U(e[h.p[t]])==(l>>u-o&(1<<o)-1)){u-=o;let e=z(h.p[t],a,l,u,n,r,s,c,f);e&&(l=e.c,u=e.lc);break}}if(t==h.lit)throw Error(`HufDecode issues`)}}}let h=8-i&7;for(l>>=h,u-=h;u>0;){let e=t[l<<d-u&m];if(e.len){u-=e.len;let t=z(e.lit,a,l,u,n,r,s,c,f);t&&(l=t.c,u=t.lc)}else throw Error(`HufDecode issues`)}return!0}function be(e,t,n,r,i,a){let o={value:0},s=n.value,c=C(t,n),l=C(t,n);n.value+=4;let u=C(t,n);if(n.value+=4,c<0||c>=f||l<0||l>=f)throw Error(`Wrong HUF_ENCSIZE`);let d=Array(f),m=Array(p);I(m);let h=r-(n.value-s);if(V(e,n,h,c,l,d),u>8*(r-(n.value-s)))throw Error(`Wrong hufUncompress`);ve(d,c,l,m),ye(d,m,e,n,u,l,a,i,o)}function W(e){return e&65535}function G(e){let t=W(e);return t>32767?t-65536:t}function K(e,t){let n=G(e),r=G(t),i=r,a=n+(i&1)+(i>>1),o=a,s=a-i;return{a:o,b:s}}function q(e,t){let n=W(e),r=W(t),i=n-(r>>1)&P,a=r+i-ge&P;return{a,b:i}}function xe(e,t,n,r,i,a,o){let s=o<16384,c=n>i?i:n,l=1,u,d;for(;l<=c;)l<<=1;for(l>>=1,u=l,l>>=1;l>=1;){d=0;let o=d+a*(i-u),c=a*l,f=a*u,p=r*l,m=r*u,h,g,_,v;for(;d<=o;d+=f){let i=d,a=d+r*(n-u);for(;i<=a;i+=m){let n=i+p,r=i+c,a=r+p;if(s){let o=K(e[i+t],e[r+t]);h=o.a,_=o.b,o=K(e[n+t],e[a+t]),g=o.a,v=o.b,o=K(h,g),e[i+t]=o.a,e[n+t]=o.b,o=K(_,v),e[r+t]=o.a,e[a+t]=o.b}else{let o=q(e[i+t],e[r+t]);h=o.a,_=o.b,o=q(e[n+t],e[a+t]),g=o.a,v=o.b,o=q(h,g),e[i+t]=o.a,e[n+t]=o.b,o=q(_,v),e[r+t]=o.a,e[a+t]=o.b}}if(n&l){let n=i+c,r;r=s?K(e[i+t],e[n+t]):q(e[i+t],e[n+t]),h=r.a,e[n+t]=r.b,e[i+t]=h}}if(i&l){let i=d,a=d+r*(n-u);for(;i<=a;i+=m){let n=i+p,r;r=s?K(e[i+t],e[n+t]):q(e[i+t],e[n+t]),h=r.a,e[n+t]=r.b,e[i+t]=h}}u=l,l>>=1}return d}function Se(e,t,n){for(let r=0;r<n;++r)t[r]=e[t[r]]}function Ce(e){let t=e.byteLength,n=[],r=0,i=new DataView(e);for(;t>0;){let e=i.getInt8(r++);if(e<0){let a=-e;t-=a+1;for(let e=0;e<a;e++)n.push(i.getUint8(r++))}else{let a=e;t-=2;let o=i.getUint8(r++);for(let e=0;e<a+1;e++)n.push(o)}}return n}function J(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function we(e){let t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),n=new Uint8Array(Ce(t)),r=new Uint8Array(n.length);return A(n),j(n,r),new DataView(r.buffer)}function Y(e){let t=e.array.slice(e.offset.value,e.offset.value+e.size),n=fflate.unzlibSync(t),r=new Uint8Array(n.length);return A(n),j(n,r),new DataView(r.buffer)}function Te(e){let t=e.array.slice(e.offset.value,e.offset.value+e.size),n=fflate.unzlibSync(t),r=e.lines*e.channels*e.width,i=e.type==1?new Uint16Array(r):new Uint32Array(r),a=0,o=0,s=[,,,,];for(let t=0;t<e.lines;t++)for(let t=0;t<e.channels;t++){let t=0;switch(e.type){case 1:s[0]=a,s[1]=s[0]+e.width,a=s[1]+e.width;for(let r=0;r<e.width;++r){let e=n[s[0]++]<<8|n[s[1]++];t+=e,i[o]=t,o++}break;case 2:s[0]=a,s[1]=s[0]+e.width,s[2]=s[1]+e.width,a=s[2]+e.width;for(let r=0;r<e.width;++r){let e=n[s[0]++]<<24|n[s[1]++]<<16|n[s[2]++]<<8;t+=e,i[o]=t,o++}break}}return new DataView(i.buffer)}function Ee(e){let t=e.viewer,n={value:e.offset.value},r=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),i=new Uint8Array(l),a=0,s=Array(e.channels);for(let t=0;t<e.channels;t++)s[t]={},s[t].start=a,s[t].end=s[t].start,s[t].nx=e.width,s[t].ny=e.lines,s[t].size=e.type,a+=s[t].nx*s[t].ny*s[t].size;let u=T(t,n),d=T(t,n);if(d>=l)throw Error(`Wrong PIZ_COMPRESSION BITMAP_SIZE`);if(u<=d)for(let e=0;e<d-u+1;e++)i[e+u]=w(t,n);let f=new Uint16Array(c),p=F(i,f),m=C(t,n);be(e.array,t,n,m,r,a);for(let t=0;t<e.channels;++t){let e=s[t];for(let n=0;n<s[t].size;++n)xe(r,e.start+n,e.nx,e.size,e.ny,e.nx*e.size,p)}Se(f,r,a);let h=0,g=new Uint8Array(r.buffer.byteLength);for(let t=0;t<e.lines;t++)for(let t=0;t<e.channels;t++){let e=s[t],n=e.nx*e.size,i=new Uint8Array(r.buffer,e.end*o,n*o);g.set(i,h),h+=n*o,e.end+=n}return new DataView(g.buffer)}var X;(function(e){e[e.Float=0]=`Float`,e[e.HalfFloat=1]=`HalfFloat`})(X||={});var Z=class{};Z.DefaultOutputType=X.HalfFloat,Z.FFLATEUrl=`https://unpkg.com/fflate@0.8.2`;async function Q(e,t,r,a){let s={size:0,viewer:t,array:new Uint8Array(t.buffer),offset:r,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,channelLineOffsets:{},scanOrder:()=>0,bytesPerLine:0,outLineWidth:0,lines:0,scanlineBlockSize:0,inputSize:null,type:0,uncompress:null,getter:()=>0,format:5,outputChannels:0,decodeChannels:{},blockCount:null,byteArray:null,linearSpace:!1,textureType:0};switch(e.compression){case v.NO_COMPRESSION:s.lines=1,s.uncompress=J;break;case v.RLE_COMPRESSION:s.lines=1,s.uncompress=we;break;case v.ZIPS_COMPRESSION:s.lines=1,s.uncompress=Y,await n.LoadScriptAsync(Z.FFLATEUrl);break;case v.ZIP_COMPRESSION:s.lines=16,s.uncompress=Y,await n.LoadScriptAsync(Z.FFLATEUrl);break;case v.PIZ_COMPRESSION:s.lines=32,s.uncompress=Ee;break;case v.PXR24_COMPRESSION:s.lines=16,s.uncompress=Te,await n.LoadScriptAsync(Z.FFLATEUrl);break;default:throw Error(v[e.compression]+` is unsupported`)}s.scanlineBlockSize=s.lines;let c={};for(let t of e.channels)switch(t.name){case`R`:case`G`:case`B`:case`A`:c[t.name]=!0,s.type=t.pixelType;break;case`Y`:c[t.name]=!0,s.type=t.pixelType;break;default:break}let l=!1;if(c.R&&c.G&&c.B&&c.A)s.outputChannels=4,s.decodeChannels={R:0,G:1,B:2,A:3};else if(c.R&&c.G&&c.B)l=!0,s.outputChannels=4,s.decodeChannels={R:0,G:1,B:2,A:3};else if(c.R&&c.G)s.outputChannels=2,s.decodeChannels={R:0,G:1};else if(c.R)s.outputChannels=1,s.decodeChannels={R:0};else if(c.Y)s.outputChannels=1,s.decodeChannels={Y:0};else throw Error(`EXRLoader.parse: file contains unsupported data channels.`);if(s.type===1)switch(a){case X.Float:s.getter=ne,s.inputSize=o;break;case X.HalfFloat:s.getter=T,s.inputSize=o;break}else if(s.type===2)switch(a){case X.Float:s.getter=D,s.inputSize=i;break;case X.HalfFloat:s.getter=ae,s.inputSize=i}else throw Error(`Unsupported pixelType `+s.type+` for `+e.compression);s.blockCount=s.height/s.scanlineBlockSize;for(let e=0;e<s.blockCount;e++)te(t,r);let u=s.width*s.height*s.outputChannels;switch(a){case X.Float:s.byteArray=new Float32Array(u),s.textureType=1,l&&s.byteArray.fill(1,0,u);break;case X.HalfFloat:s.byteArray=new Uint16Array(u),s.textureType=2,l&&s.byteArray.fill(15360,0,u);break;default:throw Error(`Unsupported type: `+a)}let d=0;for(let t of e.channels)s.decodeChannels[t.name]!==void 0&&(s.channelLineOffsets[t.name]=d*s.width),d+=t.pixelType*2;return s.bytesPerLine=s.width*d,s.outLineWidth=s.width*s.outputChannels,e.lineOrder===`INCREASING_Y`?s.scanOrder=e=>e:s.scanOrder=e=>s.height-1-e,s.outputChannels==4?(s.format=5,s.linearSpace=!0):(s.format=6,s.linearSpace=!1),s}function $(e,t,n,r){let i={value:0};for(let a=0;a<e.height/e.scanlineBlockSize;a++){let o=S(n,r)-t.dataWindow.yMin;e.size=C(n,r),e.lines=o+e.scanlineBlockSize>e.height?e.height-o:e.scanlineBlockSize;let s=e.size<e.lines*e.bytesPerLine,c=s&&e.uncompress?e.uncompress(e):J(e);r.value+=e.size;for(let n=0;n<e.scanlineBlockSize;n++){let r=a*e.scanlineBlockSize,o=n+e.scanOrder(r);if(o>=e.height)continue;let s=n*e.bytesPerLine,l=(e.height-1-o)*e.outLineWidth;for(let n=0;n<e.channels;n++){let r=t.channels[n].name,a=e.channelLineOffsets[r],o=e.decodeChannels[r];if(o!==void 0){i.value=s+a;for(let t=0;t<e.width;t++){let n=l+t*e.outputChannels+o;e.byteArray&&(e.byteArray[n]=e.getter(c,i))}}}}}}var De=class{constructor(){this.supportCascades=!1}loadCubeData(e,t,n,r,i){throw`.exr not supported in Cube.`}loadData(t,n,r){let i=new DataView(t.buffer),a={value:0},o=M(i,a);Q(o,i,a,Z.DefaultOutputType).then(e=>{$(e,o,i,a);let t=o.dataWindow.xMax-o.dataWindow.xMin+1,s=o.dataWindow.yMax-o.dataWindow.yMin+1;r(t,s,n.generateMipMaps,!1,()=>{let t=n.getEngine();n.format=o.format,n.type=e.textureType,n.invertY=!1,n._gammaSpace=!o.linearSpace,e.byteArray&&t._uploadDataToTextureDirectly(n,e.byteArray,0,0,void 0,!0)})}).catch(t=>{e.Error(`Failed to load EXR texture: `,t)})}};async function Oe(t){let n=new DataView(t),r={value:0},i=M(n,r);try{let t=await Q(i,n,r,X.Float);return $(t,i,n,r),t.byteArray?{width:i.dataWindow.xMax-i.dataWindow.xMin+1,height:i.dataWindow.yMax-i.dataWindow.yMin+1,data:new Float32Array(t.byteArray)}:(e.Error(`Failed to decode EXR data: No byte array available.`),{width:0,height:0,data:null})}catch(t){e.Error(`Failed to load EXR data: `,t)}return{width:0,height:0,data:null}}export{Oe as b,De as c};