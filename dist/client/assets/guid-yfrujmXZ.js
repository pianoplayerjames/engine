import{c as e}from"./observable-8SYwW91n.js";import{b as t}from"./logger-D2dXBhXY.js";import{b as n}from"./typeStore-CBdYsNuw.js";import{b as r}from"./engineStore-ChlzyWX_.js";import{f as i}from"./precisionDate-CPBgBNTn.js";import{G as a,H as o,g as s,z as c}from"./tools.functions-Cy84Um-0.js";function l(){return typeof _native<`u`&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}var u=class e{constructor(){this._xhr=l(),this._requestURL=``}static get IsCustomRequestAvailable(){return Object.keys(e.CustomRequestHeaders).length>0||e.CustomRequestModifiers.length>0}get requestURL(){return this._requestURL}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(let t in e.CustomRequestHeaders){let n=e.CustomRequestHeaders[t];n&&this._xhr.setRequestHeader(t,n)}}_shouldSkipRequestModifications(t){return e.SkipRequestModificationForBabylonCDN&&(t.includes(`preview.babylonjs.com`)||t.includes(`cdn.babylonjs.com`))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,n){this._xhr.addEventListener(e,t,n)}removeEventListener(e,t,n){this._xhr.removeEventListener(e,t,n)}abort(){this._xhr.abort()}send(t){e.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(t)}open(t,n){for(let t of e.CustomRequestModifiers){if(this._shouldSkipRequestModifications(n))return;n=t(this._xhr,n)||n}n=n.replace(`file:http:`,`http:`),n=n.replace(`file:https:`,`https:`),this._requestURL=n,this._xhr.open(t,n,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}};u.CustomRequestHeaders={},u.CustomRequestModifiers=[],u.SkipRequestModificationForBabylonCDN=!0;var d=class{};d.FilesToLoad={};var f=class{static ExponentialBackoff(e=3,t=500){return(n,r,i)=>r.status!==0||i>=e||n.indexOf(`file:`)!==-1?-1:2**i*t}},p=class extends Error{};p._setPrototypeOf=Object.setPrototypeOf||((e,t)=>(e.__proto__=t,e));const m={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};var h=class e extends p{constructor(t,n,r){super(t),this.errorCode=n,this.innerError=r,this.name=`RuntimeError`,p._setPrototypeOf(this,e.prototype)}};const g=e=>{let t=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=`,n=``,r,i,a,o,s,c,l,u=0,d=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);for(;u<d.length;)r=d[u++],i=u<d.length?d[u++]:NaN,a=u<d.length?d[u++]:NaN,o=r>>2,s=(r&3)<<4|i>>4,c=(i&15)<<2|a>>6,l=a&63,isNaN(i)?c=l=64:isNaN(a)&&(l=64),n+=t.charAt(o)+t.charAt(s)+t.charAt(c)+t.charAt(l);return n},_=e=>atob(e),v=e=>{let t=_(e),n=t.length,r=new Uint8Array(new ArrayBuffer(n));for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return r.buffer},y=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);var b=class e extends h{constructor(t,n){super(t,m.LoadFileError),this.name=`LoadFileError`,p._setPrototypeOf(this,e.prototype),n instanceof u?this.request=n:this.file=n}},x=class e extends h{constructor(t,n){super(t,m.RequestFileError),this.request=n,this.name=`RequestFileError`,p._setPrototypeOf(this,e.prototype)}},S=class e extends h{constructor(t,n){super(t,m.ReadFileError),this.file=n,this.name=`ReadFileError`,p._setPrototypeOf(this,e.prototype)}};const C=e=>(e=e.replace(/#/gm,`%23`),e),w={DefaultRetryStrategy:f.ExponentialBackoff(),BaseUrl:``,CorsBehavior:`anonymous`,PreprocessUrl:e=>e,ScriptBaseUrl:``,ScriptPreprocessUrl:e=>e,CleanUrl:C},T=(e,t)=>{if(!(e&&e.indexOf(`data:`)===0)&&w.CorsBehavior)if(typeof w.CorsBehavior==`string`||w.CorsBehavior instanceof String)t.crossOrigin=w.CorsBehavior;else{let n=w.CorsBehavior(e);n&&(t.crossOrigin=n)}},E={getRequiredSize:null},D=(e,t,n,i,a=``,o,s=r.LastCreatedEngine)=>{if(typeof HTMLImageElement>`u`&&!s?._features.forceBitmapOverHTMLImageElement)return n(`LoadImage is only supported in web or BabylonNative environments.`),null;let c,l=!1;e instanceof ArrayBuffer||ArrayBuffer.isView(e)?typeof Blob<`u`&&typeof URL<`u`?(c=URL.createObjectURL(new Blob([e],{type:a})),l=!0):c=`data:${a};base64,`+g(e):e instanceof Blob?(c=URL.createObjectURL(e),l=!0):(c=w.CleanUrl(e),c=w.PreprocessUrl(c));let f=t=>{if(n){let r=c||e.toString();n(`Error while trying to load image: ${r.indexOf(`http`)===0||r.length<=128?r:r.slice(0,128)+`...`}`,t)}};if(s?._features.forceBitmapOverHTMLImageElement)return k(c,r=>{s.createImageBitmap(new Blob([r],{type:a}),{premultiplyAlpha:`none`,...o}).then(e=>{t(e),l&&URL.revokeObjectURL(c)}).catch(t=>{n&&n(`Error while trying to load image: `+e,t)})},void 0,i||void 0,!0,(e,t)=>{f(t)}),null;let p=new Image;if(E.getRequiredSize){let t=E.getRequiredSize(e);t.width&&(p.width=t.width),t.height&&(p.height=t.height)}T(c,p);let m=[],h=()=>{for(let e of m)e.target.addEventListener(e.name,e.handler)},_=()=>{for(let e of m)e.target.removeEventListener(e.name,e.handler);m.length=0},v=()=>{_(),t(p),l&&p.src&&URL.revokeObjectURL(p.src)},y=e=>{_(),f(e),l&&p.src&&URL.revokeObjectURL(p.src)},b=e=>{if(e.blockedURI!==p.src||e.disposition===`report`)return;_();let t=Error(`CSP violation of policy ${e.effectiveDirective} ${e.blockedURI}. Current policy is ${e.originalPolicy}`);r.UseFallbackTexture=!1,f(t),l&&p.src&&URL.revokeObjectURL(p.src),p.src=``};m.push({target:p,name:`load`,handler:v}),m.push({target:p,name:`error`,handler:y}),m.push({target:document,name:`securitypolicyviolation`,handler:b}),h();let x=c.substring(0,5)===`blob:`,S=c.substring(0,5)===`data:`,C=()=>{x||S||!u.IsCustomRequestAvailable?p.src=c:k(c,(e,t,n)=>{let r=!a&&n?n:a,i=new Blob([e],{type:r}),o=URL.createObjectURL(i);l=!0,p.src=o},void 0,i||void 0,!0,(e,t)=>{f(t)})},D=()=>{i&&i.loadImage(c,p)};if(!x&&!S&&i&&i.enableTexturesOffline)i.open(D,C);else{if(c.indexOf(`file:`)!==-1){let e=decodeURIComponent(c.substring(5).toLowerCase());if(d.FilesToLoad[e]&&typeof URL<`u`){try{let t;try{t=URL.createObjectURL(d.FilesToLoad[e])}catch{t=URL.createObjectURL(d.FilesToLoad[e])}p.src=t,l=!0}catch{p.src=``}return p}}C()}return p},O=(t,n,r,i,a)=>{let o=new FileReader,s={onCompleteObservable:new e,abort:()=>o.abort()};return o.onloadend=()=>s.onCompleteObservable.notifyObservers(s),a&&(o.onerror=()=>{a(new S(`Unable to read ${t.name}`,t))}),o.onload=e=>{n(e.target.result)},r&&(o.onprogress=r),i?o.readAsArrayBuffer(t):o.readAsText(t),s},k=(n,r,i,a,o,s,l)=>{if(n.name)return O(n,r,i,o,s?e=>{s(void 0,e)}:void 0);let u=n;if(u.indexOf(`file:`)!==-1){let e=decodeURIComponent(u.substring(5).toLowerCase());e.indexOf(`./`)===0&&(e=e.substring(2));let t=d.FilesToLoad[e];if(t)return O(t,r,i,o,s?e=>s(void 0,new b(e.message,e.file)):void 0)}let{match:f,type:p}=N(u);if(f){let n={onCompleteObservable:new e,abort:()=>()=>{}};try{let e=o?P(u):F(u);r(e,void 0,p)}catch(e){s?s(void 0,e):t.Error(e.message||`Failed to parse the Data URL`)}return c.SetImmediate(()=>{n.onCompleteObservable.notifyObservers(n)}),n}return A(u,(e,t)=>{r(e,t?.responseURL,t?.getResponseHeader(`content-type`))},i,a,o,s?e=>{s(e.request,new b(e.message,e.request))}:void 0,l)},A=(n,r,a,o,s,c,l)=>{n=w.CleanUrl(n),n=w.PreprocessUrl(n);let d=w.BaseUrl+n,f=!1,p={onCompleteObservable:new e,abort:()=>f=!0},m=()=>{let e=new u,n=null,o,m=()=>{e&&(a&&e.removeEventListener(`progress`,a),o&&e.removeEventListener(`readystatechange`,o),e.removeEventListener(`loadend`,h))},h=()=>{m(),p.onCompleteObservable.notifyObservers(p),p.onCompleteObservable.clear(),a=void 0,o=null,h=null,c=void 0,l=void 0,r=void 0};p.abort=()=>{f=!0,h&&h(),e&&e.readyState!==(XMLHttpRequest.DONE||4)&&e.abort(),n!==null&&(clearTimeout(n),n=null),e=null};let g=n=>{let r=n.message||`Unknown error`;c&&e?c(new x(r,e)):t.Error(r)},_=t=>{if(e){if(e.open(`GET`,d),l)try{l(e)}catch(e){g(e);return}s&&(e.responseType=`arraybuffer`),a&&e.addEventListener(`progress`,a),h&&e.addEventListener(`loadend`,h),o=()=>{if(!(f||!e)&&e.readyState===(XMLHttpRequest.DONE||4)){if(o&&e.removeEventListener(`readystatechange`,o),e.status>=200&&e.status<300||e.status===0&&(!i()||j())){let t=s?e.response:e.responseText;if(t!==null){try{r&&r(t,e)}catch(e){g(e)}return}}let a=w.DefaultRetryStrategy;if(a){let r=a(d,e,t);if(r!==-1){m(),e=new u,n=setTimeout(()=>_(t+1),r);return}}let l=new x(`Error status: `+e.status+` `+e.statusText+` - Unable to load `+d,e);c&&c(l)}},e.addEventListener(`readystatechange`,o),e.send()}};_(0)};if(o&&o.enableSceneOffline&&!n.startsWith(`blob:`)){let e=e=>{e&&e.status>400?c&&c(e):m()},t=()=>{o&&o.loadFile(w.BaseUrl+n,e=>{!f&&r&&r(e),p.onCompleteObservable.notifyObservers(p)},a?e=>{!f&&a&&a(e)}:void 0,e,s)};o.open(t,e)}else m();return p},j=()=>typeof location<`u`&&location.protocol===`file:`,M=e=>y.test(e),N=e=>{let t=y.exec(e);if(t===null||t.length===0)return{match:!1,type:``};{let e=t[0].replace(`data:`,``).replace(`base64,`,``);return{match:!0,type:e}}};function P(e){return v(e.split(`,`)[1])}const F=e=>_(e.split(`,`)[1]),I=()=>{s._FileToolsLoadImage=D,o.loadFile=k,a.loadFile=k};I();let L;const R=(e,t,n,r,i,a,o,s,c,l)=>{L={DecodeBase64UrlToBinary:e,DecodeBase64UrlToString:t,DefaultRetryStrategy:n.DefaultRetryStrategy,BaseUrl:n.BaseUrl,CorsBehavior:n.CorsBehavior,PreprocessUrl:n.PreprocessUrl,IsBase64DataUrl:r,IsFileURL:i,LoadFile:a,LoadImage:o,ReadFile:s,RequestFile:c,SetCorsBehavior:l},Object.defineProperty(L,`DefaultRetryStrategy`,{get:function(){return n.DefaultRetryStrategy},set:function(e){n.DefaultRetryStrategy=e}}),Object.defineProperty(L,`BaseUrl`,{get:function(){return n.BaseUrl},set:function(e){n.BaseUrl=e}}),Object.defineProperty(L,`PreprocessUrl`,{get:function(){return n.PreprocessUrl},set:function(e){n.PreprocessUrl=e}}),Object.defineProperty(L,`CorsBehavior`,{get:function(){return n.CorsBehavior},set:function(e){n.CorsBehavior=e}})};R(P,F,w,M,j,k,D,O,A,T);var z=class{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];let r=n(e);if(r)return r;t.Warn(e+` not found, you may have missed an import.`);let i=e.split(`.`),a=window||this;for(let e=0,t=i.length;e<t;e++)a=a[i[e]];return typeof a==`function`?a:null}};z.RegisteredExternalClasses={};function B(){return`xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`.replace(/[xy]/g,e=>{let t=Math.random()*16|0,n=e===`x`?t:t&3|8;return n.toString(16)})}export{B as b,z as c,P as d,w as e,M as f,k as g,D as h,O as i,A as j,T as k,g as l,m,h as n,u as o};