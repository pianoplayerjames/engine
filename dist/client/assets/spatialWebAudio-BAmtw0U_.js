import{b as e,c as t,g as n,h as r}from"./webAudioBaseSubGraph-CYcHX6iU.js";import{b as i,c as a,f as o}from"./math.vector-Z6V1-M8S.js";import{b as s}from"./precisionDate-CPBgBNTn.js";const c={coneInnerAngle:6.28318530718,coneOuterAngle:6.28318530718,coneOuterVolume:0,distanceModel:`linear`,maxDistance:1e4,minDistance:1,panningModel:`equalpower`,position:o.Zero(),rolloffFactor:1,rotation:o.Zero(),rotationQuaternion:new a};function l(e){return e.spatialEnabled||e.spatialAutoUpdate!==void 0||e.spatialConeInnerAngle!==void 0||e.spatialConeOuterAngle!==void 0||e.spatialConeOuterVolume!==void 0||e.spatialDistanceModel!==void 0||e.spatialMaxDistance!==void 0||e.spatialMinDistance!==void 0||e.spatialMinUpdateTime!==void 0||e.spatialPanningModel!==void 0||e.spatialPosition!==void 0||e.spatialRolloffFactor!==void 0||e.spatialRotation!==void 0||e.spatialRotationQuaternion!==void 0}var u=class{};const d={pan:0};function f(e){return e.stereoEnabled||e.stereoPan!==void 0}var p=class{},m=class extends r{constructor(e){super(`Stereo`,e)}setOptions(e){this.pan=e.stereoPan??d.pan}};function h(e){return e.getSubNode(`Stereo`)}function g(e,t,n){e.callOnSubNode(`Stereo`,e=>{e[t]=n})}var _=class extends p{constructor(e){super(),this._pan=d.pan,this._subGraph=e}get pan(){return this._pan}set pan(e){this._pan=e,g(this._subGraph,`pan`,e)}},v=class{constructor(e){this._attachmentType=3,this._position=new o,this._rotationQuaternion=new a,this._sceneNode=null,this._useBoundingBox=!1,this.dispose=()=>{this.detach()},this._spatialAudioNode=e}get isAttached(){return this._sceneNode!==null}attach(e,t,n){this._sceneNode!==e&&(this.detach(),e&&(this._attachmentType=n,this._sceneNode=e,this._sceneNode.onDisposeObservable.add(this.dispose),this._useBoundingBox=t))}detach(){this._sceneNode?.onDisposeObservable.removeCallback(this.dispose),this._sceneNode=null}update(){this._attachmentType&1&&(this._useBoundingBox&&this._sceneNode.getBoundingInfo?this._position.copyFrom(this._sceneNode.getBoundingInfo().boundingBox.centerWorld):this._sceneNode?.getWorldMatrix().getTranslationToRef(this._position),this._spatialAudioNode.position.copyFrom(this._position),this._spatialAudioNode._updatePosition()),this._attachmentType&2&&(this._sceneNode?.getWorldMatrix().decompose(void 0,this._rotationQuaternion),this._spatialAudioNode.rotationQuaternion.copyFrom(this._rotationQuaternion),this._spatialAudioNode._updateRotation())}},y=class extends r{constructor(e){super(`Spatial`,e),this._attacherComponent=null}get isAttached(){return this._attacherComponent!==null&&this._attacherComponent.isAttached}attach(e,t,n){this.detach(),this._attacherComponent||=new v(this),this._attacherComponent.attach(e,t,n)}detach(){this._attacherComponent?.detach()}dispose(){super.dispose(),this._attacherComponent?.dispose(),this._attacherComponent=null}setOptions(e){this.coneInnerAngle=e.spatialConeInnerAngle??c.coneInnerAngle,this.coneOuterAngle=e.spatialConeOuterAngle??c.coneOuterAngle,this.coneOuterVolume=e.spatialConeOuterVolume??c.coneOuterVolume,this.distanceModel=e.spatialDistanceModel??c.distanceModel,this.maxDistance=e.spatialMaxDistance??c.maxDistance,this.minDistance=e.spatialMinDistance??c.minDistance,this.panningModel=e.spatialPanningModel??c.panningModel,this.rolloffFactor=e.spatialRolloffFactor??c.rolloffFactor,e.spatialPosition&&(this.position=e.spatialPosition.clone()),e.spatialRotationQuaternion?this.rotationQuaternion=e.spatialRotationQuaternion.clone():e.spatialRotation?this.rotation=e.spatialRotation.clone():this.rotationQuaternion=c.rotationQuaternion.clone(),this.update()}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation())}};function b(e){return e.getSubNode(`Spatial`)}function x(e,t,n){e.callOnSubNode(`Spatial`,e=>{e[t]=n})}const S=i.Zero(),C=new a,w=o.Zero();function T(e){return e*Math.PI/180}function E(e){return e*180/Math.PI}async function D(e){return new O(e)}var O=class extends y{constructor(e){super(e),this._lastPosition=o.Zero(),this._lastRotation=o.Zero(),this._lastRotationQuaternion=new a,this.position=c.position.clone(),this.rotation=c.rotation.clone(),this.rotationQuaternion=c.rotationQuaternion.clone(),this.node=new PannerNode(e._audioContext),this._orientationX=new t(e,this.node.orientationX),this._orientationY=new t(e,this.node.orientationY),this._orientationZ=new t(e,this.node.orientationZ),this._positionX=new t(e,this.node.positionX),this._positionY=new t(e,this.node.positionY),this._positionZ=new t(e,this.node.positionZ)}dispose(){super.dispose(),this._orientationX.dispose(),this._orientationY.dispose(),this._orientationZ.dispose(),this._positionX.dispose(),this._positionY.dispose(),this._positionZ.dispose(),this.node.disconnect()}get coneInnerAngle(){return T(this.node.coneInnerAngle)}set coneInnerAngle(e){this.node.coneInnerAngle=E(e)}get coneOuterAngle(){return T(this.node.coneOuterAngle)}set coneOuterAngle(e){this.node.coneOuterAngle=E(e)}get coneOuterVolume(){return this.node.coneOuterGain}set coneOuterVolume(e){this.node.coneOuterGain=e}get distanceModel(){return this.node.distanceModel}set distanceModel(e){this.node.distanceModel=e;let t=this.node.maxDistance;this.node.maxDistance=t+.001,this.node.maxDistance=t}get minDistance(){return this.node.refDistance}set minDistance(e){this.node.refDistance=e}get maxDistance(){return this.node.maxDistance}set maxDistance(e){this.node.maxDistance=e}get panningModel(){return this.node.panningModel}set panningModel(e){this.node.panningModel=e}get rolloffFactor(){return this.node.rolloffFactor}set rolloffFactor(e){this.node.rolloffFactor=e}get _inNode(){return this.node}get _outNode(){return this.node}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=this.position.x,this._positionY.targetValue=this.position.y,this._positionZ.targetValue=this.position.z,this._lastPosition.copyFrom(this.position))}_updateRotation(){if(!(this.isAttached&&(this._orientationX.isRamping||this._orientationY.isRamping||this._orientationZ.isRamping))){if(!this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion))C.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);else if(!this._lastRotation.equalsWithEpsilon(this.rotation))a.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,C),this._lastRotation.copyFrom(this.rotation);else return;i.FromQuaternionToRef(C,S),o.TransformNormalToRef(o.RightReadOnly,S,w),this._orientationX.targetValue=w.x,this._orientationY.targetValue=w.y,this._orientationZ.targetValue=w.z}}_connect(e){let t=super._connect(e);return t?(e._inNode&&this.node.connect(e._inNode),!0):!1}_disconnect(e){let t=super._disconnect(e);return t?(e._inNode&&this.node.disconnect(e._inNode),!0):!1}getClassName(){return`_SpatialWebAudioSubNode`}};async function k(e){return new A(e)}var A=class extends m{constructor(e){super(e),this.node=new StereoPannerNode(e._audioContext),this._pan=new t(e,this.node.pan)}dispose(){super.dispose(),this._pan.dispose()}get pan(){return this._pan.targetValue}set pan(e){this._pan.targetValue=e}get _inNode(){return this.node}get _outNode(){return this.node}getClassName(){return`_StereoWebAudioSubNode`}_connect(e){let t=super._connect(e);return t?(e._inNode&&this.node.connect(e._inNode),!0):!1}_disconnect(e){let t=super._disconnect(e);return t?(e._inNode&&this.node.disconnect(e._inNode),!0):!1}},j=class extends e{constructor(){super(...arguments),this._rootNode=null,this._inputNode=null}async initAsync(e){await super.initAsync(e);let t=!1,n=!1;(t=l(e))&&await this.createAndAddSubNodeAsync(`Spatial`),(n=f(e))&&await this.createAndAddSubNodeAsync(`Stereo`),await this._createSubNodePromisesResolvedAsync(),t&&b(this)?.setOptions(e),n&&h(this)?.setOptions(e)}get _inNode(){return this._inputNode}_createSubNode(e){try{let t=super._createSubNode(e);return t}catch{}switch(e){case`Spatial`:return D(this._owner.engine);case`Stereo`:return k(this._owner.engine);default:throw Error(`Unknown subnode name: ${e}`)}}_onSubNodesChanged(){super._onSubNodesChanged();let e=b(this),t=h(this),r=n(this);if(e&&e.getClassName()!==`_SpatialWebAudioSubNode`||t&&t.getClassName()!==`_StereoWebAudioSubNode`||r&&r.getClassName()!==`_VolumeWebAudioSubNode`)throw Error(`Not a WebAudio subnode.`);e&&(e.disconnectAll(),r&&e.connect(r)),t&&(t.disconnectAll(),r&&t.connect(r)),e&&t?(this._rootNode=new GainNode(this._owner.engine._audioContext),this._rootNode.connect(e._outNode),this._rootNode.connect(t._outNode)):(this._rootNode?.disconnect(),this._rootNode=null);let i=null,a=null;if(this._rootNode?a=this._rootNode:(e?i=e:t?i=t:r&&(i=r),a=i?.node??null),this._inputNode!==a){if(this._inputNode&&this._upstreamNodes){let e=this._upstreamNodes.values();for(let t=e.next();!t.done;t=e.next())t.value._outNode?.disconnect(this._inputNode)}if(this._inputNode=a,a&&this._upstreamNodes){let e=this._upstreamNodes.values();for(let t=e.next();!t.done;t=e.next())t.value._outNode?.connect(a)}}}},M=class extends u{constructor(e){super(),this._coneInnerAngle=c.coneInnerAngle,this._coneOuterAngle=c.coneOuterAngle,this._coneOuterVolume=c.coneOuterVolume,this._distanceModel=c.distanceModel,this._maxDistance=c.maxDistance,this._minDistance=c.minDistance,this._panningModel=c.panningModel,this._rolloffFactor=c.rolloffFactor;let t=b(e);t?(this._position=t.position.clone(),this._rotation=t.rotation.clone(),this._rotationQuaternion=t.rotationQuaternion.clone()):(this._position=c.position.clone(),this._rotation=c.rotation.clone(),this._rotationQuaternion=c.rotationQuaternion.clone(),e.createAndAddSubNodeAsync(`Spatial`)),this._subGraph=e}get coneInnerAngle(){return this._coneInnerAngle}set coneInnerAngle(e){this._coneInnerAngle=e,x(this._subGraph,`coneInnerAngle`,e)}get coneOuterAngle(){return this._coneOuterAngle}set coneOuterAngle(e){this._coneOuterAngle=e,x(this._subGraph,`coneOuterAngle`,e)}get coneOuterVolume(){return this._coneOuterVolume}set coneOuterVolume(e){this._coneOuterVolume=e,x(this._subGraph,`coneOuterVolume`,e)}get distanceModel(){return this._distanceModel}set distanceModel(e){this._distanceModel=e,x(this._subGraph,`distanceModel`,e)}get isAttached(){return this._subGraph.getSubNode(`Spatial`)?.isAttached??!1}get maxDistance(){return this._maxDistance}set maxDistance(e){e<=0&&(e=1e-6),this._maxDistance=e,x(this._subGraph,`maxDistance`,e)}get minDistance(){return this._minDistance}set minDistance(e){this._minDistance=e,x(this._subGraph,`minDistance`,e)}get panningModel(){return this._panningModel}set panningModel(e){this._panningModel=e,x(this._subGraph,`panningModel`,e)}get position(){return this._position}set position(e){this._position=e,this._updatePosition()}get rolloffFactor(){return this._rolloffFactor}set rolloffFactor(e){this._rolloffFactor=e,x(this._subGraph,`rolloffFactor`,e)}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._updateRotation()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,this._updateRotation()}attach(e,t=!1,n=3){b(this._subGraph)?.attach(e,t,n)}detach(){b(this._subGraph)?.detach()}update(){let e=b(this._subGraph);e&&(e.isAttached?e.update():(this._updatePosition(e),this._updateRotation(e)))}_updatePosition(e=null){if(!e&&(e=b(this._subGraph),!e))return;let t=e.position;t.equalsWithEpsilon(this._position)||(e.position.copyFrom(this._position),e._updatePosition())}_updateRotation(e=null){!e&&(e=b(this._subGraph),!e)||(e.rotationQuaternion.equalsWithEpsilon(this._rotationQuaternion)?e.rotation.equalsWithEpsilon(this._rotation)||(e.rotation.copyFrom(this._rotation),e._updateRotation()):(e.rotationQuaternion.copyFrom(this._rotationQuaternion),e._updateRotation()))}},N=class{constructor(e,t,n){if(this._autoUpdate=!0,this._lastUpdateTime=0,this.minUpdateTime=0,!t)return;this.minUpdateTime=n;let r=()=>{if(!this._autoUpdate)return;let t=!1;if(0<this.minUpdateTime){let e=s.Now;this._lastUpdateTime&&e-this._lastUpdateTime<this.minUpdateTime&&(t=!0),this._lastUpdateTime=e}t||e.update(),requestAnimationFrame(r)};requestAnimationFrame(r)}dispose(){this._autoUpdate=!1}},P=class extends M{constructor(e,t,n){super(e),this._updaterComponent=new N(this,t,n)}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}dispose(){this._updaterComponent.dispose(),this._updaterComponent=null}};export{P as b,N as c,j as d,v as e,_ as f,l as g};