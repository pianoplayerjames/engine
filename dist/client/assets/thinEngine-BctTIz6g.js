import{b as e}from"./logger-D2dXBhXY.js";import{f as t}from"./precisionDate-CPBgBNTn.js";import{I as n,J as r,c as i,g as a,i as o,m as s,n as c,o as l,p as u,q as d,r as f,s as p,t as m,u as h,v as g,w as _,x as v,y}from"./tools.functions-Cy84Um-0.js";import{b}from"./dataBuffer-BEUz_e_e.js";function x(e){return e.getPipelineContext===void 0}var S=class{constructor(){this.shaderLanguage=0}postProcessor(e,t,n,r,i){if(i.drawBuffersExtensionDisabled){let t=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(t,``)}return e}};const C=/(flat\s)?\s*varying\s*.*/;var w=class{constructor(){this.shaderLanguage=0}attributeProcessor(e){return e.replace(`attribute`,`in`)}varyingCheck(e,t){return C.test(e)}varyingProcessor(e,t){return e.replace(`varying`,t?`in`:`out`)}postProcessor(e,t,n){let r=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,i=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(i,``),e=e.replace(/texture2D\s*\(/g,`texture(`),n){let n=e.search(/layout *\(location *= *0\) *out/g)!==-1,i=t.indexOf(`#define DUAL_SOURCE_BLENDING`)!==-1,a=i?`layout(location = 0, index = 0) out vec4 glFragColor;
layout(location = 0, index = 1) out vec4 glFragColor2;
`:`layout(location = 0) out vec4 glFragColor;
`;i&&(e=`#extension GL_EXT_blend_func_extended : require
`+e),e=e.replace(/texture2DLodEXT\s*\(/g,`textureLod(`),e=e.replace(/textureCubeLodEXT\s*\(/g,`textureLod(`),e=e.replace(/textureCube\s*\(/g,`texture(`),e=e.replace(/gl_FragDepthEXT/g,`gl_FragDepth`),e=e.replace(/gl_FragColor/g,`glFragColor`),e=e.replace(/gl_FragData/g,`glFragData`),e=e.replace(/void\s+?main\s*\(/g,(r||n?``:a)+`void main(`)}else{let n=t.indexOf(`#define MULTIVIEW`)!==-1;if(n)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e}return e}},T=class extends b{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}},E=class{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw Error(`Unable to create webGL texture`);this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||=[],this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(let e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){return this._MSAARenderBuffers?.[e]??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}};function D(e){return e===13||e===14||e===15||e===16||e===17||e===18||e===19}function O(e){switch(e){case 13:case 17:case 18:case 14:case 16:return 1;case 15:return 5;case 19:return 0}return 0}function k(e){return e===13||e===17||e===18||e===19}var A=class{},j=class n extends a{get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return s.ShadersRepository}static set ShadersRepository(e){s.ShadersRepository=e}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(t,r,i,a){if(i||={},super(r??i.antialias,i,a),this._name=`WebGL`,this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=[],this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=[],this._currentInstanceLocations=[],this._currentInstanceBuffers=[],this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=[],this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!t)return;let o=null;if(t.getContext){if(o=t,i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.xrCompatible===void 0&&(i.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();let e=navigator.userAgent;for(let t of n.ExceptionList){let n=t.key,r=t.targets,a=new RegExp(n);if(a.test(e)){if(t.capture&&t.captureConstraint){let n=t.capture,r=t.captureConstraint,i=new RegExp(n),a=i.exec(e);if(a&&a.length>0){let e=parseInt(a[a.length-1]);if(e>=r)continue}}for(let e of r)switch(e){case`uniformBuffer`:this.disableUniformBuffers=!0;break;case`vao`:this.disableVertexArrayObjects=!0;break;case`antialias`:i.antialias=!1;break;case`maxMSAASamples`:this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{v(this._gl)}:(this._onContextLost=t=>{t.preventDefault(),this._contextWasLost=!0,v(this._gl),e.Warn(`WebGL context lost.`),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(()=>this._initGLContext())},o.addEventListener(`webglcontextrestored`,this._onContextRestored,!1),i.powerPreference=i.powerPreference||`high-performance`),o.addEventListener(`webglcontextlost`,this._onContextLost,!1),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=o.getContext(`webgl2`,i)||o.getContext(`experimental-webgl2`,i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName=`WEBGL2`,this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName=`WEBGL1`))}catch{}if(!this._gl){if(!o)throw Error(`The provided canvas is null or undefined.`);try{this._gl=o.getContext(`webgl`,i)||o.getContext(`experimental-webgl`,i)}catch{throw Error(`WebGL not supported`)}}if(!this._gl)throw Error(`WebGL not supported`)}else{this._gl=t,o=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName=`WEBGL2`):this._shaderPlatformName=`WEBGL1`;let e=this._gl.getContextAttributes();e&&(i.stencil=e.stencil)}this._sharedInit(o),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let e=0;e<this._caps.maxVertexAttribs;e++)this._currentBufferPointers[e]=new A;this._shaderProcessor=this.webGLVersion>1?new w:new S;let s=`Babylon.js v${n.Version}`;e.Log(s+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute(`data-engine`,s);let c=y(this._gl);c.validateShaderPrograms=this.validateShaderPrograms,c.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(e){return null}areAllEffectsReady(){for(let e in this._compiledEffects){let t=this._compiledEffects[e];if(!t.isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension(`KHR_parallel_shader_compile`)||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension(`OES_standard_derivatives`)!==null,maxAnisotropy:1,astc:this._gl.getExtension(`WEBGL_compressed_texture_astc`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_astc`),bptc:this._gl.getExtension(`EXT_texture_compression_bptc`)||this._gl.getExtension(`WEBKIT_EXT_texture_compression_bptc`),s3tc:this._gl.getExtension(`WEBGL_compressed_texture_s3tc`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_s3tc`),s3tc_srgb:this._gl.getExtension(`WEBGL_compressed_texture_s3tc_srgb`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_s3tc_srgb`),pvrtc:this._gl.getExtension(`WEBGL_compressed_texture_pvrtc`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_pvrtc`),etc1:this._gl.getExtension(`WEBGL_compressed_texture_etc1`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_etc1`),etc2:this._gl.getExtension(`WEBGL_compressed_texture_etc`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_etc`)||this._gl.getExtension(`WEBGL_compressed_texture_es3_0`),textureAnisotropicFilterExtension:this._gl.getExtension(`EXT_texture_filter_anisotropic`)||this._gl.getExtension(`WEBKIT_EXT_texture_filter_anisotropic`)||this._gl.getExtension(`MOZ_EXT_texture_filter_anisotropic`),uintIndices:this._webGLVersion>1||this._gl.getExtension(`OES_element_index_uint`)!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension(`EXT_frag_depth`)!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension(`EXT_disjoint_timer_query_webgl2`)||this._gl.getExtension(`EXT_disjoint_timer_query`),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension(`EXT_color_buffer_float`)),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension(`EXT_color_buffer_half_float`)),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension(`OES_texture_float`)),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension(`OES_texture_half_float`)),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension(`EXT_shader_texture_lod`)),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension(`OVR_multiview2`),oculusMultiview:this._gl.getExtension(`OCULUS_multiview`),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension(`EXT_texture_norm16`),blendParametersPerTarget:!1,dualSourceBlending:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);let e=this._gl.getExtension(`WEBGL_debug_renderer_info`);e!=null&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||=this._gl.getParameter(this._gl.VENDOR)||`Unknown vendor`,this._glRenderer||=this._gl.getParameter(this._gl.RENDERER)||`Unknown renderer`,this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension(`OES_texture_float_linear`)),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension(`OES_texture_half_float_linear`)),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763);let t=this._gl.getExtension(`OES_draw_buffers_indexed`);if(this._caps.blendParametersPerTarget=!!t,t&&(this._gl.blendEquationSeparateIndexed=t.blendEquationSeparateiOES.bind(t),this._gl.blendEquationIndexed=t.blendEquationiOES.bind(t),this._gl.blendFuncSeparateIndexed=t.blendFuncSeparateiOES.bind(t),this._gl.blendFuncIndexed=t.blendFunciOES.bind(t),this._gl.colorMaskIndexed=t.colorMaskiOES.bind(t),this._gl.disableIndexed=t.disableiOES.bind(t),this._gl.enableIndexed=t.enableiOES.bind(t)),this._caps.dualSourceBlending=!!this._gl.getExtension(`WEBGL_blend_func_extended`),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride===null?this._gl.getParameter(this._gl.MAX_SAMPLES):this._maxMSAASamplesOverride,this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{let e=this._gl.getExtension(`WEBGL_draw_buffers`);if(e!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=e.drawBuffersWEBGL.bind(e),this._caps.maxDrawBuffers=this._gl.getParameter(e.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let t=0;t<16;t++)this._gl[`COLOR_ATTACHMENT`+t+`_WEBGL`]=e[`COLOR_ATTACHMENT`+t+`_WEBGL`]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{let e=this._gl.getExtension(`WEBGL_depth_texture`);e!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=e.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{let e=this._gl.getExtension(`OES_vertex_array_object`);e!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=e.createVertexArrayOES.bind(e),this._gl.bindVertexArray=e.bindVertexArrayOES.bind(e),this._gl.deleteVertexArray=e.deleteVertexArrayOES.bind(e))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{let e=this._gl.getExtension(`ANGLE_instanced_arrays`);e==null?this._caps.instancedArrays=!1:(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),this._gl.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),this._gl.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e))}if(this._gl.getShaderPrecisionFormat){let e=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),t=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);e&&t&&(this._caps.highPrecisionShaderSupported=e.precision!==0&&t.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{let e=this._gl.getExtension(`EXT_blend_minmax`);e!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=e.MAX_EXT,this._gl.MIN=e.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{let e=this._gl.getExtension(`EXT_sRGB`);e!=null&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:e.SRGB_EXT,SRGB8:e.SRGB_ALPHA_EXT,SRGB8_ALPHA8:e.SRGB_ALPHA_EXT})}if(this._creationOptions){let e=this._creationOptions.forceSRGBBufferSupportState;e!==void 0&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&e)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let e=0;e<this._maxSimultaneousTextures;e++)this._nextFreeTextureSlots.push(e);this._glRenderer===`Mali-G72`&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:typeof HTMLImageElement>`u`,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportIBLShadows:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return`ThinEngine`}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);let e=this._workingCanvas.getContext(`2d`);e&&(this._workingContext=e)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){let e=this.getGlInfo();return e&&e.renderer?e.renderer:``}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(e,t,r,i=!1,a=0){let o=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=o;let s=0;if(t&&e){let t=!0;if(this._currentRenderTarget){let r=this._currentRenderTarget.texture?.format;if(r===8||r===9||r===10||r===11){let r=this._currentRenderTarget.texture?.type;r===7||r===5?(n._TempClearColorUint32[0]=e.r*255,n._TempClearColorUint32[1]=e.g*255,n._TempClearColorUint32[2]=e.b*255,n._TempClearColorUint32[3]=e.a*255,this._gl.clearBufferuiv(this._gl.COLOR,0,n._TempClearColorUint32),t=!1):(n._TempClearColorInt32[0]=e.r*255,n._TempClearColorInt32[1]=e.g*255,n._TempClearColorInt32[2]=e.b*255,n._TempClearColorInt32[3]=e.a*255,this._gl.clearBufferiv(this._gl.COLOR,0,n._TempClearColorInt32),t=!1)}}t&&(this._gl.clearColor(e.r,e.g,e.b,e.a===void 0?1:e.a),s|=this._gl.COLOR_BUFFER_BIT)}r&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),s|=this._gl.DEPTH_BUFFER_BIT),i&&(this._gl.clearStencil(a),s|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(s)}_viewport(e,t,n,r){(e!==this._viewportCached.x||t!==this._viewportCached.y||n!==this._viewportCached.z||r!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=n,this._viewportCached.w=r,this._gl.viewport(e,t,n,r))}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw Error(`Not Supported by ThinEngine`)}bindFramebuffer(t,n=0,r,i,a,o=0,s=0){let c=t;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,this._bindUnboundFramebuffer(c._framebuffer);let l=this._gl;t.isMulti||(t.is2DArray||t.is3D?(l.framebufferTextureLayer(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,t.texture._hardwareTexture?.underlyingResource,o,s),c._currentLOD=o):t.isCube?l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_CUBE_MAP_POSITIVE_X+n,t.texture._hardwareTexture?.underlyingResource,o):c._currentLOD!==o&&(l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,t.texture._hardwareTexture?.underlyingResource,o),c._currentLOD=o));let u=t._depthStencilTexture;if(u){t.is3D&&(t.texture.width!==u.width||t.texture.height!==u.height||t.texture.depth!==u.depth)&&e.Warn(`Depth/Stencil attachment for 3D target must have same dimensions as color attachment`);let r=t._depthStencilTextureWithStencil?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT;t.is2DArray||t.is3D?l.framebufferTextureLayer(l.FRAMEBUFFER,r,u._hardwareTexture?.underlyingResource,o,s):t.isCube?l.framebufferTexture2D(l.FRAMEBUFFER,r,l.TEXTURE_CUBE_MAP_POSITIVE_X+n,u._hardwareTexture?.underlyingResource,o):l.framebufferTexture2D(l.FRAMEBUFFER,r,l.TEXTURE_2D,u._hardwareTexture?.underlyingResource,o)}c._MSAAFramebuffer&&this._bindUnboundFramebuffer(c._MSAAFramebuffer),this._cachedViewport&&!a?this.setViewport(this._cachedViewport,r,i):(r||(r=t.width,o&&(r/=2**o)),i||(i=t.height,o&&(i/=2**o)),this._viewport(0,0,r,i)),this.wipeCaches()}setStateCullFaceType(e,t){let n=this.cullBackFaces??e??!0?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==n||t)&&(this._depthCullingState.cullFace=n)}setState(e,t=0,n,r=!1,i,a,o=0){(this._depthCullingState.cull!==e||n)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(i,n),this.setZOffset(t),this.setZOffsetUnits(o);let s=r?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==s||n)&&(this._depthCullingState.frontFace=s),this._stencilStateComposer.stencilMaterial=a}_resolveAndGenerateMipMapsFramebuffer(e,t=!1){let n=e;n.disableAutomaticMSAAResolve||(e.isMulti?this.resolveMultiFramebuffer(e):this.resolveFramebuffer(e)),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e))}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){let t=this._getTextureTarget(e);this._bindTextureDirectly(t,e,!0),this._gl.generateMipmap(t),this._bindTextureDirectly(t,null)}unBindFramebuffer(e,t,n){let r=e;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(e,t),n&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),n()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(e){!e.isMulti&&e.texture?.generateMipMaps&&!e.isCube&&this.generateMipmaps(e.texture)}resolveFramebuffer(e){let t=e,n=this._gl;if(!t._MSAAFramebuffer||t.isMulti)return;let r=t.resolveMSAAColors?n.COLOR_BUFFER_BIT:0;r|=t._generateDepthBuffer&&t.resolveMSAADepth?n.DEPTH_BUFFER_BIT:0,r|=t._generateStencilBuffer&&t.resolveMSAAStencil?n.STENCIL_BUFFER_BIT:0,n.bindFramebuffer(n.READ_FRAMEBUFFER,t._MSAAFramebuffer),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,t._framebuffer),n.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,r,n.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,n){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){let n=this._gl.createBuffer();if(!n)throw Error(`Unable to create vertex buffer`);let r=new T(n);return this.bindArrayBuffer(r),typeof e==`number`?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(e),t),r.capacity=e):e instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t),r.capacity=e.length*4):(this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),r.capacity=e.byteLength),this._resetVertexBufferBinding(),r.references=1,r}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,n){let r=this._gl.createBuffer(),i=new T(r);if(!r)throw Error(`Unable to create index buffer`);this.bindIndexBuffer(i);let a=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,a,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),i.references=1,i.is32Bits=a.BYTES_PER_ELEMENT===4,i}_normalizeIndexData(e){let t=e.BYTES_PER_ELEMENT;if(t===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let t=0;t<e.length;t++)if(e[t]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,n){let r=e.program,i=this._gl.getUniformBlockIndex(r,t);this._gl.uniformBlockBinding(r,i,n)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,n,r,i,a,o){let s=this._currentBufferPointers[t];if(!s)return;let c=!1;s.active?(s.buffer!==e&&(s.buffer=e,c=!0),s.size!==n&&(s.size=n,c=!0),s.type!==r&&(s.type=r,c=!0),s.normalized!==i&&(s.normalized=i,c=!0),s.stride!==a&&(s.stride=a,c=!0),s.offset!==o&&(s.offset=o,c=!0)):(c=!0,s.active=!0,s.index=t,s.size=n,s.type=r,s.normalized=i,s.stride=a,s.offset=o,s.buffer=e),(c||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),r===this._gl.UNSIGNED_INT||r===this._gl.INT?this._gl.vertexAttribIPointer(t,n,r,a,o):this._gl.vertexAttribPointer(t,n,r,i,a,o))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,n){let r=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let i=0;i<r.length;i++){let a=t.getAttributeLocation(i);if(a>=0){let t=r[i],o=null;if(n&&(o=n[t]),o||=e[t],!o)continue;this._gl.enableVertexAttribArray(a),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[a]=!0);let s=o.getBuffer();s&&(this._vertexAttribPointer(s,a,o.getSize(),o.type,o.normalized,o.byteStride,o.byteOffset),o.getIsInstanced()&&(this._gl.vertexAttribDivisor(a,o.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(s))))}}}recordVertexArrayObject(e,t,n,r){let i=this._gl.createVertexArray();if(!i)throw Error(`Unable to create VAO`);return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(i),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,n,r),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),i}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,n,r,i){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i;let t=i.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let a=0;for(let o=0;o<t;o++)if(o<n.length){let t=i.getAttributeLocation(o);t>=0&&(this._gl.enableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=!0,this._vertexAttribPointer(e,t,n[o],this._gl.FLOAT,!1,r,a)),a+=n[o]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,n,r){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==n)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=n,this._bindVertexBuffersAttributes(e,n,r)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,n=this._currentInstanceLocations.length;t<n;t++){let n=this._currentInstanceBuffers[t];e!=n&&n.references&&(e=n,this.bindArrayBuffer(n));let r=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(r,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,n){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),n[0].index!==void 0)this.bindInstancesBuffer(e,n,!0);else for(let t=0;t<4;t++){let r=n[t];this._vertexAttribArraysEnabled[r]||(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0),this._vertexAttribPointer(e,r,4,this._gl.FLOAT,!1,64,t*16),this._gl.vertexAttribDivisor(r,1),this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,n=!0){this.bindArrayBuffer(e);let r=0;if(n)for(let e=0;e<t.length;e++){let n=t[e];r+=n.attributeSize*4}for(let n=0;n<t.length;n++){let i=t[n];i.index===void 0&&(i.index=this._currentEffect.getAttributeLocationByName(i.attributeName)),!(i.index<0)&&(this._vertexAttribArraysEnabled[i.index]||(this._gl.enableVertexAttribArray(i.index),this._vertexAttribArraysEnabled[i.index]=!0),this._vertexAttribPointer(e,i.index,i.attributeSize,i.attributeType||this._gl.FLOAT,i.normalized||!1,r,i.offset),this._gl.vertexAttribDivisor(i.index,i.divisor===void 0?1:i.divisor),this._currentInstanceLocations.push(i.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;let t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,n;for(;(n=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(n,1),this._currentInstanceBuffers.splice(n,1),t=!0,n=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,n,r){this.drawElementsType(e?0:1,t,n,r)}drawPointClouds(e,t,n){this.drawArraysType(2,e,t,n)}drawUnIndexed(e,t,n,r){this.drawArraysType(e?0:1,t,n,r)}drawElementsType(e,t,n,r){this.applyStates(),this._reportDrawCall();let i=this._drawMode(e),a=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;r?this._gl.drawElementsInstanced(i,n,a,t*o,r):this._gl.drawElements(i,n,a,t*o)}drawArraysType(e,t,n,r){this.applyStates(),this._reportDrawCall();let i=this._drawMode(e);r?this._gl.drawArraysInstanced(i,t,n,r):this._gl.drawArrays(i,t,n)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];let t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){let t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,c(t),this._gl&&(this._currentProgram===t.program&&this._setProgram(null),this._gl.deleteProgram(t.program)))}_getGlobalDefines(e){return r(e,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(e,t,n,r,i,a,o,c,l,u=0,d){let f=typeof e==`string`?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,p=typeof e==`string`?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,m=this._getGlobalDefines(),h=t.attributes!==void 0,g=i??t.defines??``;m&&(g+=m);let _=f+`+`+p+`@`+g;if(this._compiledEffects[_]){let e=this._compiledEffects[_];return o&&e.isReady()&&o(e),e._refCount++,e}this._gl&&y(this._gl);let v=new s(e,t,h?this:n,r,this,i,a,o,c,l,_,t.shaderLanguage??u,t.extraInitializationsAsync??d);return this._compiledEffects[_]=v,v}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,n,r,i=null){let a=y(this._gl);return a._contextWasLost=this._contextWasLost,a.validateShaderPrograms=this.validateShaderPrograms,g(e,t,n,r||this._gl,i)}createShaderProgram(e,t,n,r,i,a=null){let o=y(this._gl);return o._contextWasLost=this._contextWasLost,o.validateShaderPrograms=this.validateShaderPrograms,_(e,t,n,r,i||this._gl,a)}inlineShaderCode(e){return e}createPipelineContext(e){if(this._gl){let e=y(this._gl);e.parallelShaderCompile=this._caps.parallelShaderCompile}let t=h(this._gl,e);return t.engine=this,t}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(e){return d(e,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(e,t,n,r,i,a,o,s,c,l,u){let d=y(this._gl);return d._contextWasLost=this._contextWasLost,d.validateShaderPrograms=this.validateShaderPrograms,d._createShaderProgramInjection=this._createShaderProgram.bind(this),d.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),d.createShaderProgramInjection=this.createShaderProgram.bind(this),d.loadFileInjection=this._loadFile.bind(this),p(e,t,n,r,i,a,o,s,c,l,u)}_createShaderProgram(e,t,n,r,i=null){return l(e,t,n,r,i)}_isRenderingStateCompiled(e){return this._isDisposed?!1:f(e,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(e,t){u(e,t)}getUniforms(e,t){let n=[],r=e;for(let e=0;e<t.length;e++)n.push(this._gl.getUniformLocation(r.program,t[e]));return n}getAttributes(e,t){let n=[],r=e;for(let e=0;e<t.length;e++)try{n.push(this._gl.getAttribLocation(r.program,t[e]))}catch{n.push(-1)}return n}enableEffect(e){e=e!==null&&x(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,n){return e?(this._gl.uniform2i(e,t,n),!0):!1}setInt3(e,t,n,r){return e?(this._gl.uniform3i(e,t,n,r),!0):!1}setInt4(e,t,n,r,i){return e?(this._gl.uniform4i(e,t,n,r,i),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!=0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!=0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!=0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,n){return e?(this._gl.uniform2ui(e,t,n),!0):!1}setUInt3(e,t,n,r){return e?(this._gl.uniform3ui(e,t,n,r),!0):!1}setUInt4(e,t,n,r,i){return e?(this._gl.uniform4ui(e,t,n,r,i),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!=0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!=0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!=0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!=0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!=0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!=0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,n){return e?(this._gl.uniform2f(e,t,n),!0):!1}setFloat3(e,t,n,r){return e?(this._gl.uniform3f(e,t,n,r),!0):!1}setFloat4(e,t,n,r,i){return e?(this._gl.uniform4f(e,t,n,r,i),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl,this._currentRenderTarget&&this._currentRenderTarget.textures?this._currentRenderTarget.textures.length:1),this._colorWriteChanged){this._colorWriteChanged=!1;let e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._resetAlphaMode(),this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){let n=this._gl,r=n.NEAREST,i=n.NEAREST,a=!1;switch(e){case 11:r=n.LINEAR,i=t?n.LINEAR_MIPMAP_NEAREST:n.LINEAR;break;case 3:r=n.LINEAR,a=!0,i=t?n.LINEAR_MIPMAP_LINEAR:n.LINEAR;break;case 8:a=!0,r=n.NEAREST,i=t?n.NEAREST_MIPMAP_LINEAR:n.NEAREST;break;case 4:r=n.NEAREST,i=t?n.NEAREST_MIPMAP_NEAREST:n.NEAREST;break;case 5:r=n.NEAREST,i=t?n.LINEAR_MIPMAP_NEAREST:n.LINEAR;break;case 6:a=!0,r=n.NEAREST,i=t?n.LINEAR_MIPMAP_LINEAR:n.LINEAR;break;case 7:r=n.NEAREST,i=n.LINEAR;break;case 1:r=n.NEAREST,i=n.NEAREST;break;case 9:r=n.LINEAR,i=t?n.NEAREST_MIPMAP_NEAREST:n.NEAREST;break;case 10:a=!0,r=n.LINEAR,i=t?n.NEAREST_MIPMAP_LINEAR:n.NEAREST;break;case 2:r=n.LINEAR,i=n.LINEAR;break;case 12:r=n.LINEAR,i=n.NEAREST;break}return{min:i,mag:r,hasMipMaps:a}}_createTexture(){let e=this._gl.createTexture();if(!e)throw Error(`Unable to create texture`);return e}_createHardwareTexture(){return new E(this._createTexture(),this._gl)}_createInternalTexture(t,n,r=!0,i=0){let a=!1,s=!1,c=0,l=3,u=5,d=!1,f=1,p,m=!1,h=0;n!==void 0&&typeof n==`object`?(a=!!n.generateMipMaps,s=!!n.createMipMaps,c=n.type===void 0?0:n.type,l=n.samplingMode===void 0?3:n.samplingMode,u=n.format===void 0?5:n.format,d=n.useSRGBBuffer===void 0?!1:n.useSRGBBuffer,f=n.samples??1,p=n.label,m=!!n.createMSAATexture,h=n.comparisonFunction||0):a=!!n,d&&=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU),(c===1&&!this._caps.textureFloatLinearFiltering||c===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),c===1&&!this._caps.textureFloat&&(c=0,e.Warn(`Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE`));let g=D(u),_=k(u),v=this._gl,y=new o(this,i),b=t.width||t,x=t.height||t,S=t.depth||0,C=t.layers||0,w=this._getSamplingParameters(l,(a||s)&&!g),T=C===0?S===0?v.TEXTURE_2D:v.TEXTURE_3D:v.TEXTURE_2D_ARRAY,E=g?this._getInternalFormatFromDepthTextureFormat(u,!0,_):this._getRGBABufferInternalSizedFormat(c,u,d),O=g?_?v.DEPTH_STENCIL:v.DEPTH_COMPONENT:this._getInternalFormat(u),A=g?this._getWebGLTextureTypeFromDepthTextureFormat(u):this._getWebGLTextureType(c);if(this._bindTextureDirectly(T,y),C===0?S===0?v.texImage2D(T,0,E,b,x,0,O,A,null):(y.is3D=!0,v.texImage3D(T,0,E,b,x,S,0,O,A,null)):(y.is2DArray=!0,v.texImage3D(T,0,E,b,x,C,0,O,A,null)),v.texParameteri(T,v.TEXTURE_MAG_FILTER,w.mag),v.texParameteri(T,v.TEXTURE_MIN_FILTER,w.min),v.texParameteri(T,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(T,v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE),g&&this.webGLVersion>1&&(h===0?(v.texParameteri(T,v.TEXTURE_COMPARE_FUNC,515),v.texParameteri(T,v.TEXTURE_COMPARE_MODE,v.NONE)):(v.texParameteri(T,v.TEXTURE_COMPARE_FUNC,h),v.texParameteri(T,v.TEXTURE_COMPARE_MODE,v.COMPARE_REF_TO_TEXTURE))),(a||s)&&this._gl.generateMipmap(T),this._bindTextureDirectly(T,null),y._useSRGBBuffer=d,y.baseWidth=b,y.baseHeight=x,y.width=b,y.height=x,y.depth=C||S,y.isReady=!0,y.samples=f,y.generateMipMaps=a,y.samplingMode=l,y.type=c,y.format=u,y.label=p,y.comparisonFunction=h,this._internalTexturesCache.push(y),m){let e=null;if(e=D(y.format)?this._setupFramebufferDepthAttachments(k(y.format),y.format!==19,y.width,y.height,f,y.format,!0):this._createRenderBuffer(y.width,y.height,f,-1,this._getRGBABufferInternalSizedFormat(y.type,y.format,y._useSRGBBuffer),-1),!e)throw Error(`Unable to create render buffer`);y._autoMSAAManagement=!0;let t=y._hardwareTexture;t||=y._hardwareTexture=this._createHardwareTexture(),t.addMSAARenderBuffer(e)}return y}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||t)}createTexture(e,t,n,r,i=3,a=null,s=null,c=null,l=null,u=null,d=null,f,p,m,h){return this._createTextureBase(e,t,n,r,i,a,s,(...e)=>this._prepareWebGLTexture(...e,u),(e,t,n,i,a,s)=>{let c=this._gl,l=n.width===e&&n.height===t;a._creationFlags=m??0;let u=this._getTexImageParametersForCreateTexture(a.format,a._useSRGBBuffer);if(l)return c.texImage2D(c.TEXTURE_2D,0,u.internalFormat,u.format,u.type,n),!1;let d=this._caps.maxTextureSize;if(n.width>d||n.height>d||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext?!1:(this._workingCanvas.width=e,this._workingCanvas.height=t,this._workingContext.drawImage(n,0,0,n.width,n.height,0,0,e,t),c.texImage2D(c.TEXTURE_2D,0,u.internalFormat,u.format,u.type,this._workingCanvas),a.width=e,a.height=t,!1);{let e=new o(this,2);this._bindTextureDirectly(c.TEXTURE_2D,e,!0),c.texImage2D(c.TEXTURE_2D,0,u.internalFormat,u.format,u.type,n),this._rescaleTexture(e,a,r,u.format,()=>{this._releaseTexture(e),this._bindTextureDirectly(c.TEXTURE_2D,a,!0),s()})}return!0},c,l,u,d,f,p,h)}_getTexImageParametersForCreateTexture(e,t){let n,r;return this.webGLVersion===1?(n=this._getInternalFormat(e,t),r=n):(n=this._getInternalFormat(e,!1),r=this._getRGBABufferInternalSizedFormat(0,e,t)),{internalFormat:r,format:n,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(e,t,n,r,i){}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,n=!1){let r=this._getTextureTarget(t),i=this._getSamplingParameters(e,t.useMipMaps||n);this._setTextureParameterInteger(r,this._gl.TEXTURE_MAG_FILTER,i.mag,t),this._setTextureParameterInteger(r,this._gl.TEXTURE_MIN_FILTER,i.min),n&&i.hasMipMaps&&(t.generateMipMaps=!0,this._gl.generateMipmap(r)),this._bindTextureDirectly(r,null),t.samplingMode=e}updateTextureDimensions(e,t,n,r=1){}updateTextureWrappingMode(e,t,n=null,r=null){let i=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(i,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),n!==null&&(this._setTextureParameterInteger(i,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(n),e),e._cachedWrapV=n),(e.is2DArray||e.is3D)&&r!==null&&(this._setTextureParameterInteger(i,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r),e),e._cachedWrapR=r),this._bindTextureDirectly(i,null)}_uploadCompressedDataToTextureDirectly(e,t,n,r,i,a=0,o=0){let s=this._gl,c=s.TEXTURE_2D;if(e.isCube&&(c=s.TEXTURE_CUBE_MAP_POSITIVE_X+a),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=s.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=s.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(c,o,t,n,r,0,i)}_uploadDataToTextureDirectly(e,t,n=0,r=0,i,a=!1){let o=this._gl,s=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format),l=i===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(i,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let u=o.TEXTURE_2D;e.isCube&&(u=o.TEXTURE_CUBE_MAP_POSITIVE_X+n);let d=Math.round(Math.log(e.width)*Math.LOG2E),f=Math.round(Math.log(e.height)*Math.LOG2E),p=a?e.width:2**Math.max(d-r,0),m=a?e.height:2**Math.max(f-r,0);o.texImage2D(u,r,l,p,m,0,c,s,t)}updateTextureData(e,t,n,r,i,a,o=0,s=0,c=!1){let l=this._gl,u=this._getWebGLTextureType(e.type),d=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let f=l.TEXTURE_2D,p=l.TEXTURE_2D;e.isCube&&(p=l.TEXTURE_CUBE_MAP_POSITIVE_X+o,f=l.TEXTURE_CUBE_MAP),this._bindTextureDirectly(f,e,!0),l.texSubImage2D(p,s,n,r,i,a,d,u,t),c&&this._gl.generateMipmap(p),this._bindTextureDirectly(f,null)}_uploadArrayBufferViewToTexture(e,t,n=0,r=0){let i=this._gl,a=e.isCube?i.TEXTURE_CUBE_MAP:i.TEXTURE_2D;this._bindTextureDirectly(a,e,!0),this._uploadDataToTextureDirectly(e,t,n,r),this._bindTextureDirectly(a,null,!0)}_prepareWebGLTextureContinuation(e,t,n,r,i){let a=this._gl;if(!a)return;let o=this._getSamplingParameters(i,!n);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,o.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,o.min),!n&&!r&&a.generateMipmap(a.TEXTURE_2D),this._bindTextureDirectly(a.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,n,r,a,o,s,c,l,u){let d=this.getCaps().maxTextureSize,f=Math.min(d,this.needPOTTextures?i(r.width,d):r.width),p=Math.min(d,this.needPOTTextures?i(r.height,d):r.height),m=this._gl;if(m){if(!e._hardwareTexture){n&&n.removePendingData(e);return}this._bindTextureDirectly(m.TEXTURE_2D,e,!0),this._unpackFlipY(a===void 0?!0:!!a),e.baseWidth=r.width,e.baseHeight=r.height,e.width=f,e.height=p,e.isReady=!0,e.type=e.type===-1?0:e.type,e.format=e.format===-1?u??(t===`.jpg`&&!e._useSRGBBuffer?4:5):e.format,!c(f,p,r,t,e,()=>{this._prepareWebGLTextureContinuation(e,n,o,s,l)})&&this._prepareWebGLTextureContinuation(e,n,o,s,l)}}_getInternalFormatFromDepthTextureFormat(e,t,n){let r=this._gl;if(!t)return r.STENCIL_INDEX8;let i=n?r.DEPTH_STENCIL:r.DEPTH_COMPONENT,a=i;return this.webGLVersion>1?e===15?a=r.DEPTH_COMPONENT16:e===16?a=r.DEPTH_COMPONENT24:e===17||e===13?a=n?r.DEPTH24_STENCIL8:r.DEPTH_COMPONENT24:e===14?a=r.DEPTH_COMPONENT32F:e===18&&(a=n?r.DEPTH32F_STENCIL8:r.DEPTH_COMPONENT32F):a=r.DEPTH_COMPONENT16,a}_getWebGLTextureTypeFromDepthTextureFormat(e){let t=this._gl,n=t.UNSIGNED_INT;return e===15?n=t.UNSIGNED_SHORT:e===17||e===13?n=t.UNSIGNED_INT_24_8:e===14?n=t.FLOAT:e===18?n=t.FLOAT_32_UNSIGNED_INT_24_8_REV:e===19&&(n=t.UNSIGNED_BYTE),n}_setupFramebufferDepthAttachments(e,t,n,r,i=1,a,o=!1){let s=this._gl;a??=e?13:14;let c=this._getInternalFormatFromDepthTextureFormat(a,t,e);return e&&t?this._createRenderBuffer(n,r,i,s.DEPTH_STENCIL,c,o?-1:s.DEPTH_STENCIL_ATTACHMENT):t?this._createRenderBuffer(n,r,i,c,c,o?-1:s.DEPTH_ATTACHMENT):e?this._createRenderBuffer(n,r,i,c,c,o?-1:s.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,n,r,i,a,o=!0){let s=this._gl,c=s.createRenderbuffer();return this._updateRenderBuffer(c,e,t,n,r,i,a,o)}_updateRenderBuffer(e,t,n,r,i,a,o,s=!0){let c=this._gl;return c.bindRenderbuffer(c.RENDERBUFFER,e),r>1&&c.renderbufferStorageMultisample?c.renderbufferStorageMultisample(c.RENDERBUFFER,r,a,t,n):c.renderbufferStorage(c.RENDERBUFFER,i,t,n),o!==-1&&c.framebufferRenderbuffer(c.FRAMEBUFFER,o,c.RENDERBUFFER,e),s&&c.bindRenderbuffer(c.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture),this.unbindAllTextures();let t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_deleteTexture(e){e?.release()}_setProgram(e){this._currentProgram!==e&&(m(e,this._gl),this._currentProgram=e)}bindSamplers(e){let t=e.getPipelineContext();this._setProgram(t.program);let n=e.getSamplers();for(let t=0;t<n.length;t++){let r=e.getUniform(n[t]);r&&(this._boundUniforms[t]=r)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(t,n,r=!1,i=!1){let a=!1,o=n&&n._associatedChannel>-1;r&&o&&(this._activeChannel=n._associatedChannel);let s=this._boundTexturesCache[this._activeChannel];if(s!==n||i){if(this._activateCurrentTexture(),n&&n.isMultiview)throw e.Error([`_bindTextureDirectly called with a multiview texture!`,t,n]),`_bindTextureDirectly called with a multiview texture!`;this._gl.bindTexture(t,n?._hardwareTexture?.underlyingResource??null),this._boundTexturesCache[this._activeChannel]=n,n&&(n._associatedChannel=this._activeChannel)}else r&&(a=!0,this._activateCurrentTexture());return o&&!r&&this._bindSamplerUniformToChannel(n._associatedChannel,this._activeChannel),a}_bindTexture(e,t,n){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;let r=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(r,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,n,r){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,n))}_bindSamplerUniformToChannel(e,t){let n=this._boundUniforms[e];!n||n._currentState===t||(this._gl.uniform1i(n,t),n._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,n=!1,r=!1,i=``){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;let n=t.getInternalTexture();n&&(n._associatedChannel=e),t.update()}else if(t.delayLoadState===4)return t.delayLoad(),!1;let a;a=r?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!n&&a&&(a._associatedChannel=e);let o=!0;this._boundTexturesCache[e]===a&&(n||this._bindSamplerUniformToChannel(a._associatedChannel,e),o=!1),this._activeChannel=e;let s=this._getTextureTarget(a);if(o&&this._bindTextureDirectly(s,a,n),a&&!a.isMultiview){if(a.isCube&&a._cachedCoordinatesMode!==t.coordinatesMode){a._cachedCoordinatesMode=t.coordinatesMode;let e=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=e,t.wrapV=e}a._cachedWrapU!==t.wrapU&&(a._cachedWrapU=t.wrapU,this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),a)),a._cachedWrapV!==t.wrapV&&(a._cachedWrapV=t.wrapV,this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),a)),a.is3D&&a._cachedWrapR!==t.wrapR&&(a._cachedWrapR=t.wrapR,this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),a)),this._setAnisotropicLevel(s,a,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,n,r){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==n.length)&&(this._textureUnits=new Int32Array(n.length));for(let t=0;t<n.length;t++){let r=n[t].getInternalTexture();r?(this._textureUnits[t]=e+t,r._associatedChannel=e+t):this._textureUnits[t]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let e=0;e<n.length;e++)this._setTexture(this._textureUnits[e],n[e],!0)}}_setAnisotropicLevel(e,t,n){let r=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(n=1),r&&t._cachedAnisotropicFilteringLevel!==n&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(n,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=n)}_setTextureParameterFloat(e,t,n,r){this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameterf(e,t,n)}_setTextureParameterInteger(e,t,n,r){r&&this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameteri(e,t,n)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){t()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener(`webglcontextlost`,this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener(`webglcontextrestored`,this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose&&this._gl.getExtension(`WEBGL_lose_context`)?.loseContext(),v(this._gl)}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener(`webglcontextlost`,e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener(`webglcontextrestored`,e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){let t=this._gl;for(;t.getError()!==t.NO_ERROR;);let n=!0,r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);let i=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);let a=t.checkFramebufferStatus(t.FRAMEBUFFER);if(n&&=a===t.FRAMEBUFFER_COMPLETE,n&&=t.getError()===t.NO_ERROR,n&&(t.clear(t.COLOR_BUFFER_BIT),n&&=t.getError()===t.NO_ERROR),n){t.bindFramebuffer(t.FRAMEBUFFER,null);let e=t.RGBA,r=t.UNSIGNED_BYTE,i=new Uint8Array(4);t.readPixels(0,0,1,1,e,r,i),n&&=t.getError()===t.NO_ERROR}for(t.deleteTexture(r),t.deleteFramebuffer(i),t.bindFramebuffer(t.FRAMEBUFFER,null);!n&&t.getError()!==t.NO_ERROR;);return n}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let n=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:n=this._gl.ALPHA;break;case 1:n=this._gl.LUMINANCE;break;case 2:n=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:n=this._gl.RED;break;case 7:case 33324:case 36761:n=this._gl.RG;break;case 4:case 32852:case 36762:n=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:n=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:n=this._gl.RED_INTEGER;break;case 9:n=this._gl.RG_INTEGER;break;case 10:n=this._gl.RGB_INTEGER;break;case 11:n=this._gl.RGBA_INTEGER;break}return n}_getRGBABufferInternalSizedFormat(e,t,n=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return n?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return n?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return n?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return n?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(t,n,r,i,a=!0,o=!0,s=null){let c=a?4:3,l=a?this._gl.RGBA:this._gl.RGB,u=r*i*c;if(!s)s=new Uint8Array(u);else if(s.length<u)return e.Error(`Data buffer is too small to store the read pixels (${s.length} should be more than ${u})`),Promise.resolve(s);return o&&this.flushFramebuffer(),this._gl.readPixels(t,n,r,i,l,this._gl.UNSIGNED_BYTE,s),Promise.resolve(s)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{let e=a._CreateCanvas(1,1),t=e.getContext(`webgl`)||e.getContext(`experimental-webgl`);this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{let e=a._CreateCanvas(1,1),t=e.getContext(`webgl`,{failIfMajorPerformanceCaveat:!0})||e.getContext(`experimental-webgl`,{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}};j._TempClearColorUint32=new Uint32Array(4),j._TempClearColorInt32=new Int32Array(4),j.ExceptionList=[{key:`Chrome/63.0`,capture:`63\\.0\\.3239\\.(\\d+)`,captureConstraint:108,targets:[`uniformBuffer`]},{key:`Firefox/58`,capture:null,captureConstraint:null,targets:[`uniformBuffer`]},{key:`Firefox/59`,capture:null,captureConstraint:null,targets:[`uniformBuffer`]},{key:`Chrome/72.+?Mobile`,capture:null,captureConstraint:null,targets:[`vao`]},{key:`Chrome/73.+?Mobile`,capture:null,captureConstraint:null,targets:[`vao`]},{key:`Chrome/74.+?Mobile`,capture:null,captureConstraint:null,targets:[`vao`]},{key:`Mac OS.+Chrome/71`,capture:null,captureConstraint:null,targets:[`vao`]},{key:`Mac OS.+Chrome/72`,capture:null,captureConstraint:null,targets:[`vao`]},{key:`Mac OS.+Chrome`,capture:null,captureConstraint:null,targets:[`uniformBuffer`]},{key:`Chrome/12\\d\\..+?Mobile`,capture:null,captureConstraint:null,targets:[`uniformBuffer`]},{key:`.*AppleWebKit.*(15.4).*Safari`,capture:null,captureConstraint:null,targets:[`antialias`,`maxMSAASamples`]},{key:`.*(15.4).*AppleWebKit.*Safari`,capture:null,captureConstraint:null,targets:[`antialias`,`maxMSAASamples`]}],j._ConcatenateShader=n,j._IsSupported=null,j._HasMajorPerformanceCaveat=null;export{j as b,O as c,k as d,D as e,E as f,T as g,S as h,x as i};