import{c as e}from"./observable-8SYwW91n.js";import{d as t}from"./webAudioBaseSubGraph-CYcHX6iU.js";import{b as n}from"./logger-D2dXBhXY.js";import{b as r,d as i,f as a,g as o}from"./spatialWebAudio-BAmtw0U_.js";import{b as s,c}from"./abstractSoundInstance-BcAyeUyt.js";import{c as l}from"./tools-BmEJizBm.js";var u=class extends c{constructor(e,t){super(e,t),this._preloadedInstances=[]}get preloadCount(){return this._options.preloadCount??1}get preloadCompletedCount(){return this._preloadedInstances.length}preloadInstanceAsync(){let e=this._createInstance();return this._addPreloadedInstance(e),e.preloadedPromise}async preloadInstancesAsync(e){for(let t=0;t<e;t++)this.preloadInstanceAsync();await Promise.all(this._preloadedInstances.map(async e=>await e.preloadedPromise))}play(e={}){if(this.state===5){this.resume();return}let t;this.preloadCompletedCount>0?(t=this._preloadedInstances[0],t.startOffset=this.startOffset,this._removePreloadedInstance(t)):t=this._createInstance();let n=()=>{t.state===3&&(this._stopExcessInstances(),t.onStateChangedObservable.removeCallback(n))};t.onStateChangedObservable.add(n),e.startOffset??=this.startOffset,e.loop??=this.loop,e.volume??=1,this._beforePlay(t),t.play(e),this._afterPlay(t)}stop(){if(this._setState(1),this._instances)for(let e of Array.from(this._instances))e.stop()}_addPreloadedInstance(e){this._preloadedInstances.includes(e)||this._preloadedInstances.push(e)}_removePreloadedInstance(e){let t=this._preloadedInstances.indexOf(e);t!==-1&&this._preloadedInstances.splice(t,1)}},d=class extends s{constructor(t){super(t),this.onReadyObservable=new e,this.preloadedPromise=new Promise((e,t)=>{this._rejectPreloadedProimse=t,this._resolvePreloadedPromise=e}),this.onErrorObservable.add(this._rejectPreloadedProimse),this.onReadyObservable.add(this._resolvePreloadedPromise)}set startOffset(e){this._options.startOffset=e}dispose(){super.dispose(),this.onErrorObservable.clear(),this.onReadyObservable.clear(),this._resolvePreloadedPromise()}},f=class e extends u{constructor(t,n,r){super(t,n),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,typeof r.spatialAutoUpdate==`boolean`&&(this._spatialAutoUpdate=r.spatialAutoUpdate),typeof r.spatialMinUpdateTime==`number`&&(this._spatialMinUpdateTime=r.spatialMinUpdateTime),this._options={autoplay:r.autoplay??!1,loop:r.loop??!1,maxInstances:r.maxInstances??1/0,preloadCount:r.preloadCount??1,startOffset:r.startOffset??0},this._subGraph=new e._SubGraph(this)}async _initAsync(e,t){let n=this.engine._audioContext;if(!(n instanceof AudioContext))throw Error(`Unsupported audio context type.`);this._audioContext=n,this._source=e,t.outBus?this.outBus=t.outBus:t.outBusAutoDefault!==!1&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(t),o(t)&&this._initSpatialProperty(),this.preloadCount&&await this.preloadInstancesAsync(this.preloadCount),t.autoplay&&this.play(t),this.engine._addNode(this)}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??=new a(this._subGraph)}dispose(){super.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this)}getClassName(){return`_WebAudioStreamingSound`}_createInstance(){return new p(this,this._options)}_connect(e){let t=super._connect(e);return t?(e._inNode&&this._outNode?.connect(e._inNode),!0):!1}_disconnect(e){let t=super._disconnect(e);return t?(e._inNode&&this._outNode?.disconnect(e._inNode),!0):!1}_initSpatialProperty(){return this._spatial||=new r(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime),this._spatial}};f._SubGraph=class extends i{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};var p=class extends d{constructor(e,t){super(e),this._currentTimeChangedWhilePaused=!1,this._enginePlayTime=1/0,this._enginePauseTime=0,this._isReady=!1,this._isReadyPromise=new Promise((e,t)=>{this._resolveIsReadyPromise=e,this._rejectIsReadyPromise=t}),this._onCanPlayThrough=()=>{this._isReady=!0,this._resolveIsReadyPromise(this._mediaElement),this.onReadyObservable.notifyObservers(this)},this._onEnded=()=>{this.onEndedObservable.notifyObservers(this),this.dispose()},this._onError=e=>{this._setState(4),this.onErrorObservable.notifyObservers(e),this._rejectIsReadyPromise(e),this.dispose()},this._onEngineStateChanged=()=>{this.engine.state===`running`&&(this._options.loop&&this.state===2&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged))},this._onUserGesture=()=>{this.play()},this._options=t,this._volumeNode=new GainNode(e._audioContext),typeof e._source==`string`?this._initFromUrl(e._source):Array.isArray(e._source)?this._initFromUrls(e._source):e._source instanceof HTMLMediaElement&&this._initFromMediaElement(e._source)}get currentTime(){if(this._state===1)return 0;let e=this._state===5?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+e+this._options.startOffset}set currentTime(e){let t=this._state===2||this._state===3;t&&(this._mediaElement.pause(),this._setState(1)),this._options.startOffset=e,t?this.play({startOffset:e}):this._state===5&&(this._currentTimeChangedWhilePaused=!0)}get _outNode(){return this._volumeNode}get startTime(){return this._state===1?0:this._enginePlayTime}dispose(){super.dispose(),this.stop(),this._sourceNode?.disconnect(this._volumeNode),this._sourceNode=null,this._mediaElement.removeEventListener(`error`,this._onError),this._mediaElement.removeEventListener(`ended`,this._onEnded),this._mediaElement.removeEventListener(`canplaythrough`,this._onCanPlayThrough);for(let e of Array.from(this._mediaElement.children))this._mediaElement.removeChild(e);this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged),this.engine.userGestureObservable.removeCallback(this._onUserGesture)}play(e={}){if(this._state===3)return;e.loop!==void 0&&(this._options.loop=e.loop),this._mediaElement.loop=this._options.loop;let t=e.startOffset;this._currentTimeChangedWhilePaused?(t=this._options.startOffset,this._currentTimeChangedWhilePaused=!1):this._state===5&&(t=this.currentTime+this._options.startOffset),t&&t>0&&(this._mediaElement.currentTime=t),this._volumeNode.gain.value=e.volume??1,this._play()}pause(){this._state!==2&&this._state!==3||(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._mediaElement.pause())}resume(){(this._state===5||this._currentTimeChangedWhilePaused)&&this.play()}stop(){this._state!==1&&this._stop()}getClassName(){return`_WebAudioStreamingSoundInstance`}_connect(e){let t=super._connect(e);return t?(e instanceof f&&e._inNode&&this._outNode?.connect(e._inNode),!0):!1}_disconnect(e){let t=super._disconnect(e);return t?(e instanceof f&&e._inNode&&this._outNode?.disconnect(e._inNode),!0):!1}_initFromMediaElement(e){if(l.SetCorsBehavior(e.currentSrc,e),e.controls=!1,e.loop=this._options.loop,e.preload=`auto`,e.addEventListener(`canplaythrough`,this._onCanPlayThrough,{once:!0}),e.addEventListener(`ended`,this._onEnded,{once:!0}),e.addEventListener(`error`,this._onError,{once:!0}),e.load(),this._sourceNode=new MediaElementAudioSourceNode(this._sound._audioContext,{mediaElement:e}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound))throw Error(`Connect failed`);this._mediaElement=e}_initFromUrl(e){let n=new Audio(t(e));this._initFromMediaElement(n)}_initFromUrls(e){let n=new Audio;for(let r of e){let e=document.createElement(`source`);e.src=t(r),n.appendChild(e)}this._initFromMediaElement(n)}_play(){if(this._setState(2),!this._isReady){this._playWhenReady();return}if(this._state===2)if(this.engine.state===`running`){let e=this._mediaElement.play();this._enginePlayTime=this.engine.currentTime,this._setState(3),e.catch(()=>{this._setState(4),this._options.loop&&this.engine.userGestureObservable.addOnce(this._onUserGesture)})}else this._options.loop?this.engine.stateChangedObservable.add(this._onEngineStateChanged):(this.stop(),this._setState(4))}_playWhenReady(){this._isReadyPromise.then(()=>{this._play()}).catch(()=>{n.Error(`Streaming sound instance failed to play`),this._setState(4)})}_stop(){this._mediaElement.pause(),this._setState(1),this._onEnded(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}};export{f as b};