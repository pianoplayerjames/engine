import{f as e}from"./math.vector-Z6V1-M8S.js";var t=class{static ConvertPanoramaToCubemap(e,t,n,r,i=!1){if(!e)throw`ConvertPanoramaToCubemap: input cannot be null`;if(e.length!=t*n*3)throw`ConvertPanoramaToCubemap: input size is wrong`;let a=this.CreateCubemapTexture(r,this.FACE_FRONT,e,t,n,i),o=this.CreateCubemapTexture(r,this.FACE_BACK,e,t,n,i),s=this.CreateCubemapTexture(r,this.FACE_LEFT,e,t,n,i),c=this.CreateCubemapTexture(r,this.FACE_RIGHT,e,t,n,i),l=this.CreateCubemapTexture(r,this.FACE_UP,e,t,n,i),u=this.CreateCubemapTexture(r,this.FACE_DOWN,e,t,n,i);return{front:a,back:o,left:s,right:c,up:l,down:u,size:r,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,n,r,i,a=!1){let o=new ArrayBuffer(e*e*4*3),s=new Float32Array(o),c=a?Math.max(1,Math.round(r/4/e)):1,l=1/c,u=l*l,d=t[1].subtract(t[0]).scale(l/e),f=t[3].subtract(t[2]).scale(l/e),p=1/e,m=0;for(let a=0;a<e;a++)for(let o=0;o<c;o++){let o=t[0],h=t[2];for(let t=0;t<e;t++)for(let l=0;l<c;l++){let c=h.subtract(o).scale(m).add(o);c.normalize();let l=this.CalcProjectionSpherical(c,n,r,i);s[a*e*3+t*3+0]+=l.r*u,s[a*e*3+t*3+1]+=l.g*u,s[a*e*3+t*3+2]+=l.b*u,o=o.add(d),h=h.add(f)}m+=p*l}return s}static CalcProjectionSpherical(e,t,n,r){let i=Math.atan2(e.z,e.x),a=Math.acos(e.y);for(;i<-Math.PI;)i+=2*Math.PI;for(;i>Math.PI;)i-=2*Math.PI;let o=i/Math.PI,s=a/Math.PI;o=o*.5+.5;let c=Math.round(o*n);c<0?c=0:c>=n&&(c=n-1);let l=Math.round(s*r);l<0?l=0:l>=r&&(l=r-1);let u=r-l-1,d=t[u*n*3+c*3+0],f=t[u*n*3+c*3+1],p=t[u*n*3+c*3+2];return{r:d,g:f,b:p}}};t.FACE_LEFT=[new e(-1,-1,-1),new e(1,-1,-1),new e(-1,1,-1),new e(1,1,-1)],t.FACE_RIGHT=[new e(1,-1,1),new e(-1,-1,1),new e(1,1,1),new e(-1,1,1)],t.FACE_FRONT=[new e(1,-1,-1),new e(1,-1,1),new e(1,1,-1),new e(1,1,1)],t.FACE_BACK=[new e(-1,-1,1),new e(-1,-1,-1),new e(-1,1,1),new e(-1,1,-1)],t.FACE_DOWN=[new e(1,1,-1),new e(1,1,1),new e(-1,1,-1),new e(-1,1,1)],t.FACE_UP=[new e(-1,-1,-1),new e(-1,-1,1),new e(1,-1,-1),new e(1,-1,1)];function n(e,t){return t>1023?e*2**1023*2**(t-1023):t<-1074?e*2**-1074*2**(t+1074):e*2**t}function r(e,t,r,i,a,o){a>0?(a=n(1,a-136),e[o+0]=t*a,e[o+1]=r*a,e[o+2]=i*a):(e[o+0]=0,e[o+1]=0,e[o+2]=0)}function i(e,t){let n=``,r=``;for(let i=t;i<e.length-t&&(r=String.fromCharCode(e[i]),r!=`
`);i++)n+=r;return n}function a(e){let t=0,n=0,r=i(e,0);if(r[0]!=`#`||r[1]!=`?`)throw`Bad HDR Format.`;let a=!1,o=!1,s=0;do s+=r.length+1,r=i(e,s),r==`FORMAT=32-bit_rle_rgbe`?o=!0:r.length==0&&(a=!0);while(!a);if(!o)throw`HDR Bad header format, unsupported FORMAT`;s+=r.length+1,r=i(e,s);let c=/^-Y (.*) \+X (.*)$/g,l=c.exec(r);if(!l||l.length<3)throw`HDR Bad header format, no size`;if(n=parseInt(l[2]),t=parseInt(l[1]),n<8||n>32767)throw`HDR Bad header format, unsupported size`;return s+=r.length+1,{height:t,width:n,dataPosition:s}}function o(e,n,r=!1){let i=new Uint8Array(e),o=a(i),c=s(i,o),l=t.ConvertPanoramaToCubemap(c,o.width,o.height,n,r);return l}function s(e,t){return c(e,t)}function c(e,t){let n=t.height,i=t.width,a,o,s,c,u,d=t.dataPosition,f=0,p=0,m=0,h=new ArrayBuffer(i*4),g=new Uint8Array(h),_=new ArrayBuffer(t.width*t.height*4*3),v=new Float32Array(_);for(;n>0;){if(a=e[d++],o=e[d++],s=e[d++],c=e[d++],a!=2||o!=2||s&128||t.width<8||t.width>32767)return l(e,t);if((s<<8|c)!=i)throw`HDR Bad header format, wrong scan line width`;for(f=0,m=0;m<4;m++)for(p=(m+1)*i;f<p;)if(a=e[d++],o=e[d++],a>128){if(u=a-128,u==0||u>p-f)throw`HDR Bad Format, bad scanline data (run)`;for(;u-- >0;)g[f++]=o}else{if(u=a,u==0||u>p-f)throw`HDR Bad Format, bad scanline data (non-run)`;if(g[f++]=o,--u>0)for(let t=0;t<u;t++)g[f++]=e[d++]}for(m=0;m<i;m++)a=g[m],o=g[m+i],s=g[m+2*i],c=g[m+3*i],r(v,a,o,s,c,(t.height-n)*i*3+m*3);n--}return v}function l(e,t){let n=t.height,i=t.width,a,o,s,c,l,u=t.dataPosition,d=new ArrayBuffer(t.width*t.height*4*3),f=new Float32Array(d);for(;n>0;){for(l=0;l<t.width;l++)a=e[u++],o=e[u++],s=e[u++],c=e[u++],r(f,a,o,s,c,(t.height-n)*i*3+l*3);n--}return f}var u=class{constructor(){this.supportCascades=!1}loadCubeData(){throw`.hdr not supported in Cube.`}loadData(e,t,n){let r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),i=a(r),o=s(r,i),c=i.width*i.height,l=new Float32Array(c*4);for(let e=0;e<c;e+=1)l[e*4]=o[e*3],l[e*4+1]=o[e*3+1],l[e*4+2]=o[e*3+2],l[e*4+3]=1;n(i.width,i.height,t.generateMipMaps,!1,()=>{let e=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,e._uploadDataToTextureDirectly(t,l)})}};export{u as b,o as c,t as d};