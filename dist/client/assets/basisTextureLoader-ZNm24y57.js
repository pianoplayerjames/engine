import{c as e}from"./tools-BmEJizBm.js";import{i as t}from"./tools.functions-Cy84Um-0.js";import{b as n}from"./texture-DsComtb9.js";function r(){let e={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC4:4,cTFBC5:5,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFBGR565:15,cTFRGBA4444:16,cTFFXT1_RGB:17,cTFPVRTC2_4_RGB:18,cTFPVRTC2_4_RGBA:19,cTFETC2_EAC_R11:20,cTFETC2_EAC_RG11:21},t=null;onmessage=a=>{if(a.data.action===`init`){if(a.data.url)try{importScripts(a.data.url)}catch(e){postMessage({action:`error`,error:e})}t||=BASIS({wasmBinary:a.data.wasmBinary}),t!==null&&t.then(e=>{BASIS=e,e.initializeBasis(),postMessage({action:`init`})})}else if(a.data.action===`transcode`){let t=a.data.config,o=a.data.imageData,s=new BASIS.BasisFile(o),c=r(s),l=a.data.ignoreSupportedFormats?null:n(a.data.config,c),u=!1;l===null&&(u=!0,l=c.hasAlpha?e.cTFBC3:e.cTFBC1);let d=!0;s.startTranscoding()||(d=!1);let f=[];for(let e=0;e<c.images.length&&d;e++){let n=c.images[e];if(t.loadSingleImage===void 0||t.loadSingleImage===e){let r=n.levels.length;t.loadMipmapLevels===!1&&(r=1);for(let t=0;t<r;t++){let r=n.levels[t],a=i(s,e,t,l,u);if(!a){d=!1;break}r.transcodedPixels=a,f.push(r.transcodedPixels.buffer)}}}s.close(),s.delete(),u&&(l=-1),d?postMessage({action:`transcode`,success:d,id:a.data.id,fileInfo:c,format:l},f):postMessage({action:`transcode`,success:d,id:a.data.id})}};function n(t,n){let r=null;return t.supportedCompressionFormats&&(r=t.supportedCompressionFormats.astc?e.cTFASTC_4x4:t.supportedCompressionFormats.bc7?e.cTFBC7:t.supportedCompressionFormats.s3tc?n.hasAlpha?e.cTFBC3:e.cTFBC1:t.supportedCompressionFormats.pvrtc?n.hasAlpha?e.cTFPVRTC1_4_RGBA:e.cTFPVRTC1_4_RGB:t.supportedCompressionFormats.etc2?e.cTFETC2:t.supportedCompressionFormats.etc1?e.cTFETC1:e.cTFRGB565),r}function r(e){let t=e.getHasAlpha(),n=e.getNumImages(),r=[];for(let t=0;t<n;t++){let n={levels:[]},i=e.getNumLevels(t);for(let r=0;r<i;r++){let i={width:e.getImageWidth(t,r),height:e.getImageHeight(t,r)};n.levels.push(i)}r.push(n)}let i={hasAlpha:t,images:r};return i}function i(e,t,n,r,i){let o=e.getImageTranscodedSizeInBytes(t,n,r),s=new Uint8Array(o);if(!e.transcodeImage(s,t,n,r,1,0))return null;if(i){let r=e.getImageWidth(t,n)+3&-4,i=e.getImageHeight(t,n)+3&-4;s=a(s,0,r,i)}return s}function a(e,t,n,r){let i=new Uint16Array(4),a=new Uint16Array(n*r),o=n/4,s=r/4;for(let r=0;r<s;r++)for(let s=0;s<o;s++){let c=t+8*(r*o+s);i[0]=e[c]|e[c+1]<<8,i[1]=e[c+2]|e[c+3]<<8,i[2]=(2*(i[0]&31)+1*(i[1]&31))/3|(2*(i[0]&2016)+1*(i[1]&2016))/3&2016|(2*(i[0]&63488)+1*(i[1]&63488))/3&63488,i[3]=(2*(i[1]&31)+1*(i[0]&31))/3|(2*(i[1]&2016)+1*(i[0]&2016))/3&2016|(2*(i[1]&63488)+1*(i[0]&63488))/3&63488;for(let t=0;t<4;t++){let o=e[c+4+t],l=(r*4+t)*n+s*4;a[l++]=i[o&3],a[l++]=i[o>>2&3],a[l++]=i[o>>4&3],a[l++]=i[o>>6&3]}}return a}}async function i(t,n,r){return await new Promise((i,a)=>{let o=e=>{e.data.action===`init`?(t.removeEventListener(`message`,o),i(t)):e.data.action===`error`&&a(e.data.error||`error initializing worker`)};t.addEventListener(`message`,o),t.postMessage({action:`init`,url:r?e.GetBabylonScriptURL(r):void 0,wasmBinary:n},[n])})}var a;(function(e){e[e.cTFETC1=0]=`cTFETC1`,e[e.cTFETC2=1]=`cTFETC2`,e[e.cTFBC1=2]=`cTFBC1`,e[e.cTFBC3=3]=`cTFBC3`,e[e.cTFBC4=4]=`cTFBC4`,e[e.cTFBC5=5]=`cTFBC5`,e[e.cTFBC7=6]=`cTFBC7`,e[e.cTFPVRTC1_4_RGB=8]=`cTFPVRTC1_4_RGB`,e[e.cTFPVRTC1_4_RGBA=9]=`cTFPVRTC1_4_RGBA`,e[e.cTFASTC_4x4=10]=`cTFASTC_4x4`,e[e.cTFATC_RGB=11]=`cTFATC_RGB`,e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]=`cTFATC_RGBA_INTERPOLATED_ALPHA`,e[e.cTFRGBA32=13]=`cTFRGBA32`,e[e.cTFRGB565=14]=`cTFRGB565`,e[e.cTFBGR565=15]=`cTFBGR565`,e[e.cTFRGBA4444=16]=`cTFRGBA4444`,e[e.cTFFXT1_RGB=17]=`cTFFXT1_RGB`,e[e.cTFPVRTC2_4_RGB=18]=`cTFPVRTC2_4_RGB`,e[e.cTFPVRTC2_4_RGBA=19]=`cTFPVRTC2_4_RGBA`,e[e.cTFETC2_EAC_R11=20]=`cTFETC2_EAC_R11`,e[e.cTFETC2_EAC_RG11=21]=`cTFETC2_EAC_RG11`})(a||={});const o={JSModuleURL:`${e._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${e._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`},s=(e,t)=>{let n;switch(e){case a.cTFETC1:n=36196;break;case a.cTFBC1:n=33776;break;case a.cTFBC4:n=33779;break;case a.cTFASTC_4x4:n=37808;break;case a.cTFETC2:n=37496;break;case a.cTFBC7:n=36492;break}if(n===void 0)throw`The chosen Basis transcoder format is not currently supported`;return n};let c=null,l=null,u=0;const d=!1,f=async()=>(c||=new Promise((t,n)=>{l?t(l):e.LoadFileAsync(e.GetBabylonScriptURL(o.WasmModuleURL)).then(e=>{if(typeof URL!=`function`)return n(`Basis transcoder requires an environment with a URL constructor`);let a=URL.createObjectURL(new Blob([`(${r})()`],{type:`application/javascript`}));l=new Worker(a),i(l,e,o.JSModuleURL).then(t,n)}).catch(n)}),await c),p=async(e,t)=>{let n=e instanceof ArrayBuffer?new Uint8Array(e):e;return await new Promise((e,r)=>{f().then(()=>{let i=u++,a=t=>{t.data.action===`transcode`&&t.data.id===i&&(l.removeEventListener(`message`,a),t.data.success?e(t.data):r(`Transcode is not supported on this device`))};l.addEventListener(`message`,a);let o=new Uint8Array(n.byteLength);o.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength)),l.postMessage({action:`transcode`,id:i,imageData:o,config:t,ignoreSupportedFormats:d},[o.buffer])},e=>{r(e)})})},m=(e,t)=>{let n=t._gl?.TEXTURE_2D;e.isCube&&(n=t._gl?.TEXTURE_CUBE_MAP),t._bindTextureDirectly(n,e,!0)},h=(r,i)=>{let o=r.getEngine();for(let s=0;s<i.fileInfo.images.length;s++){let c=i.fileInfo.images[s].levels[0];if(r._invertVScale=r.invertY,i.format===-1||i.format===a.cTFRGB565)if(r.type=10,r.format=4,o._features.basisNeedsPOT&&(Math.log2(c.width)%1!=0||Math.log2(c.height)%1!=0)){let e=new t(o,2);r._invertVScale=r.invertY,e.type=10,e.format=4,e.width=c.width+3&-4,e.height=c.height+3&-4,m(e,o),o._uploadDataToTextureDirectly(e,new Uint16Array(c.transcodedPixels.buffer),s,0,4,!0),o._rescaleTexture(e,r,o.scenes[0],o._getInternalFormat(4),()=>{o._releaseTexture(e),m(r,o)})}else r._invertVScale=!r.invertY,r.width=c.width+3&-4,r.height=c.height+3&-4,r.samplingMode=2,m(r,o),o._uploadDataToTextureDirectly(r,new Uint16Array(c.transcodedPixels.buffer),s,0,4,!0);else{r.width=c.width,r.height=c.height,r.generateMipMaps=i.fileInfo.images[s].levels.length>1;let t=g.GetInternalFormatFromBasisFormat(i.format,o);r.format=t,m(r,o);let a=i.fileInfo.images[s].levels;for(let e=0;e<a.length;e++){let n=a[e];o._uploadCompressedDataToTextureDirectly(r,t,n.width,n.height,n.transcodedPixels,s,e)}o._features.basisNeedsPOT&&(Math.log2(r.width)%1!=0||Math.log2(r.height)%1!=0)&&(e.Warn(`Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1.`),r._cachedWrapU=n.CLAMP_ADDRESSMODE,r._cachedWrapV=n.CLAMP_ADDRESSMODE)}}},g={JSModuleURL:o.JSModuleURL,WasmModuleURL:o.WasmModuleURL,GetInternalFormatFromBasisFormat:s,TranscodeAsync:p,LoadTextureFromTranscodeResult:h};Object.defineProperty(g,`JSModuleURL`,{get:function(){return o.JSModuleURL},set:function(e){o.JSModuleURL=e}}),Object.defineProperty(g,`WasmModuleURL`,{get:function(){return o.WasmModuleURL},set:function(e){o.WasmModuleURL=e}});var _=class{constructor(){this.supportCascades=!1}loadCubeData(t,n,r,i,a){if(Array.isArray(t))return;let o=n.getEngine().getCaps(),s={supportedCompressionFormats:{etc1:!!o.etc1,s3tc:!!o.s3tc,pvrtc:!!o.pvrtc,etc2:!!o.etc2,astc:!!o.astc,bc7:!!o.bptc}};p(t,s).then(e=>{let t=e.fileInfo.images[0].levels.length>1&&n.generateMipMaps;h(n,e),n.getEngine()._setCubeMapTextureParams(n,t),n.isReady=!0,n.onLoadedObservable.notifyObservers(n),n.onLoadedObservable.clear(),i&&i()}).catch(t=>{let r=`Failed to transcode Basis file, transcoding may not be supported on this device`;e.Warn(r),n.isReady=!0,a&&a(t)})}loadData(t,n,r){let i=n.getEngine().getCaps(),a={supportedCompressionFormats:{etc1:!!i.etc1,s3tc:!!i.s3tc,pvrtc:!!i.pvrtc,etc2:!!i.etc2,astc:!!i.astc,bc7:!!i.bptc}};p(t,a).then(e=>{let t=e.fileInfo.images[0].levels[0],i=e.fileInfo.images[0].levels.length>1&&n.generateMipMaps;r(t.width,t.height,i,e.format!==-1,()=>{h(n,e)})}).catch(t=>{e.Warn(`Failed to transcode Basis file, transcoding may not be supported on this device`),e.Warn(`Failed to transcode Basis file: ${t}`),r(0,0,!1,!1,()=>{},!0)})}};export{_ as b};