import{b as e}from"./logger-D2dXBhXY.js";import{b as t}from"./math.scalar.functions-DzEGaKm0.js";import{g as n,h as r,i}from"./tools.functions-Cy84Um-0.js";import{b as a,h as o}from"./guid-yfrujmXZ.js";import{c as s,e as c,x as l}from"./textureTools-Dk6qLkw3.js";function u(e){let t=e.split(`?`)[0],n=t.lastIndexOf(`.`),r=n>-1?t.substring(n).toLowerCase():``;return r}n.prototype._partialLoadFile=function(e,t,n,r,i=null){let a=e=>{n[t]=e,n._internalCount++,n._internalCount===6&&r(n)},o=(e,t)=>{i&&e&&i(e.status+` `+e.statusText,t)};this._loadFile(e,a,void 0,void 0,!0,o)},n.prototype._cascadeLoadFiles=function(e,t,n,r=null){let i=[];i._internalCount=0;for(let e=0;e<6;e++)this._partialLoadFile(n[e],e,i,t,r)},n.prototype._cascadeLoadImgs=function(e,t,n,r,i=null,a){let o=[];o._internalCount=0;for(let s=0;s<6;s++)this._partialLoadImg(r[s],s,o,e,t,n,i,a)},n.prototype._partialLoadImg=function(e,t,n,r,i,s,c=null,l){let u=a(),d=e=>{n[t]=e,n._internalCount++,r&&r.removePendingData(u),n._internalCount===6&&s&&s(i,n)},f=(e,t)=>{r&&r.removePendingData(u),c&&c(e,t)};o(e,d,f,r?r.offlineProvider:null,l),r&&r.addPendingData(u)},n.prototype.createCubeTextureBase=function(t,n,a,o,s=null,c=null,l,d=null,f=!1,p=0,m=0,h=null,g=null,_=null,v=!1,y=null){let b=h||new i(this,7);b.isCube=!0,b.url=t,b.generateMipMaps=!o,b._lodGenerationScale=p,b._lodGenerationOffset=m,b._useSRGBBuffer=!!v&&this._caps.supportSRGBBuffers&&(this.version>1||this.isWebGPU||!!o),b!==h&&(b.label=t.substring(0,60)),this._doNotHandleContextLost||(b._extension=d,b._files=a,b._buffer=y);let x=t;this._transformTextureUrl&&!h&&(t=this._transformTextureUrl(t));let S=d??u(t),C=r(S),w=(t,n)=>{b.dispose(),c?c(t,n):t&&e.Warn(t)},T=(r,i)=>{t===x?r&&w(r.status+` `+r.statusText,i):(e.Warn(`Failed to load ${t}, falling back to the ${x}`),this.createCubeTextureBase(x,n,a,!!o,s,w,l,d,f,p,m,b,g,_,v,y))};if(C)C.then(e=>{let r=t=>{g&&g(b,t),e.loadCubeData(t,b,f,s,(e,t)=>{w(e,t)})};y?r(y):a&&a.length===6?e.supportCascades?this._cascadeLoadFiles(n,e=>r(e.map(e=>new Uint8Array(e))),a,w):w(`Textures type does not support cascades.`):this._loadFile(t,e=>r(new Uint8Array(e)),void 0,void 0,!0,T)});else{if(!a||a.length===0)throw Error(`Cannot load cubemap because files were not defined, or the correct loader was not found.`);this._cascadeLoadImgs(n,b,(e,t)=>{_&&_(e,t)},a,w)}return this._internalTexturesCache.push(b),b};const d=542327876,f=131072,p=512,m=4,h=64,g=131072;function _(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function v(e){return String.fromCharCode(e&255,e>>8&255,e>>16&255,e>>24&255)}const y=_(`DXT1`),b=_(`DXT3`),x=_(`DXT5`),S=_(`DX10`),C=113,w=116,T=2,E=10,D=88,O=31,ee=0,te=1,k=2,A=3,j=4,M=7,N=20,P=21,F=22,I=23,L=24,R=25,z=26,B=28,V=32;var H=class n{static GetDDSInfo(e){let t=new Int32Array(e.buffer,e.byteOffset,O),n=new Int32Array(e.buffer,e.byteOffset,O+4),r=1;t[k]&f&&(r=Math.max(1,t[M]));let i=t[P],a=i===S?n[V]:0,o=0;switch(i){case C:o=2;break;case w:o=1;break;case S:if(a===E){o=2;break}if(a===T){o=1;break}}return{width:t[j],height:t[A],mipmapCount:r,isFourCC:(t[N]&m)===m,isRGB:(t[N]&h)===h,isLuminance:(t[N]&g)===g,isCube:(t[B]&p)===p,isCompressed:i===y||i===b||i===x,dxgiFormat:a,textureType:o}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,r,i,a,o){let c=new Float32Array(i),l=new Uint16Array(a,r),u=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){let i=(t+r*e)*4;c[u]=s(l[i]),c[u+1]=s(l[i+1]),c[u+2]=s(l[i+2]),n.StoreLODInAlphaChannel?c[u+3]=o:c[u+3]=s(l[i+3]),u+=4}return c}static _GetHalfFloatRGBAArrayBuffer(e,t,r,i,a,o){if(n.StoreLODInAlphaChannel){let n=new Uint16Array(i),s=new Uint16Array(a,r),l=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){let i=(t+r*e)*4;n[l]=s[i],n[l+1]=s[i+1],n[l+2]=s[i+2],n[l+3]=c(o),l+=4}return n}return new Uint16Array(a,r,i)}static _GetFloatRGBAArrayBuffer(e,t,r,i,a,o){if(n.StoreLODInAlphaChannel){let n=new Float32Array(i),s=new Float32Array(a,r),c=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){let i=(t+r*e)*4;n[c]=s[i],n[c+1]=s[i+1],n[c+2]=s[i+2],n[c+3]=o,c+=4}return n}return new Float32Array(a,r,i)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,r,i,a,o){let s=new Uint16Array(i),l=new Float32Array(a,r),u=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++)s[u]=c(l[u]),s[u+1]=c(l[u+1]),s[u+2]=c(l[u+2]),n.StoreLODInAlphaChannel?s[u+3]=c(o):s[u+3]=c(l[u+3]),u+=4;return s}static _GetFloatAsUIntRGBAArrayBuffer(e,r,i,a,o,s){let c=new Uint8Array(a),l=new Float32Array(o,i),u=0;for(let i=0;i<r;i++)for(let r=0;r<e;r++){let a=(r+i*e)*4;c[u]=t(l[a])*255,c[u+1]=t(l[a+1])*255,c[u+2]=t(l[a+2])*255,n.StoreLODInAlphaChannel?c[u+3]=s:c[u+3]=t(l[a+3])*255,u+=4}return c}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,r,i,a,o,c){let l=new Uint8Array(a),u=new Uint16Array(o,i),d=0;for(let i=0;i<r;i++)for(let r=0;r<e;r++){let a=(r+i*e)*4;l[d]=t(s(u[a]))*255,l[d+1]=t(s(u[a+1]))*255,l[d+2]=t(s(u[a+2]))*255,n.StoreLODInAlphaChannel?l[d+3]=c:l[d+3]=t(s(u[a+3]))*255,d+=4}return l}static _GetRGBAArrayBuffer(e,t,n,r,i,a,o,s,c){let l=new Uint8Array(r),u=new Uint8Array(i,n),d=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++){let r=(t+n*e)*4;l[d]=u[r+a],l[d+1]=u[r+o],l[d+2]=u[r+s],l[d+3]=u[r+c],d+=4}return l}static _ExtractLongWordOrder(e){return e===0||e===255||e===-16777216?0:1+n._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,n,r,i,a,o,s){let c=new Uint8Array(r),l=new Uint8Array(i,n),u=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++){let r=(t+n*e)*3;c[u]=l[r+a],c[u+1]=l[r+o],c[u+2]=l[r+s],u+=3}return c}static _GetLuminanceArrayBuffer(e,t,n,r,i){let a=new Uint8Array(r),o=new Uint8Array(i,n),s=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++){let r=t+n*e;a[s]=o[r],s++}return a}static UploadDDSLevels(t,r,i,a,o,s,c=-1,u,p=!0){let m=null;a.sphericalPolynomial&&(m=[]);let h=!!t.getCaps().s3tc;r.generateMipMaps=o;let g=new Int32Array(i.buffer,i.byteOffset,O),_,N,B,V=0,H,U,W,G,K=0,q=1;if(g[ee]!==d){e.Error(`Invalid magic number in DDS header`);return}if(!a.isFourCC&&!a.isRGB&&!a.isLuminance){e.Error(`Unsupported format, must contain a FourCC, RGB or LUMINANCE code`);return}if(a.isCompressed&&!h){e.Error(`Compressed textures are not supported on this platform.`);return}let J=g[F];H=g[te]+4;let Y=!1;if(a.isFourCC)switch(_=g[P],_){case y:q=8,K=33777;break;case b:q=16,K=33778;break;case x:q=16,K=33779;break;case C:Y=!0,J=64;break;case w:Y=!0,J=128;break;case S:{H+=20;let e=!1;switch(a.dxgiFormat){case E:Y=!0,J=64,e=!0;break;case T:Y=!0,J=128,e=!0;break;case D:a.isRGB=!0,a.isFourCC=!1,J=32,e=!0;break}if(e)break}default:e.Error([`Unsupported FourCC code:`,v(_)]);return}let X=n._ExtractLongWordOrder(g[I]),Z=n._ExtractLongWordOrder(g[L]),Q=n._ExtractLongWordOrder(g[R]),ne=n._ExtractLongWordOrder(g[z]);Y&&(K=t._getRGBABufferInternalSizedFormat(a.textureType)),W=1,g[k]&f&&o!==!1&&(W=Math.max(1,g[M]));let re=u||0,$=t.getCaps();for(let e=re;e<s;e++){for(N=g[j],B=g[A],G=0;G<W;++G){if(c===-1||c===G){let o=c===-1?G:0;if(!a.isCompressed&&a.isFourCC){r.format=5,V=N*B*4;let a=null;if(t._badOS||t._badDesktopOS||!$.textureHalfFloat&&!$.textureFloat)J===128?(a=n._GetFloatAsUIntRGBAArrayBuffer(N,B,i.byteOffset+H,V,i.buffer,o),m&&o==0&&m.push(n._GetFloatRGBAArrayBuffer(N,B,i.byteOffset+H,V,i.buffer,o))):J===64&&(a=n._GetHalfFloatAsUIntRGBAArrayBuffer(N,B,i.byteOffset+H,V,i.buffer,o),m&&o==0&&m.push(n._GetHalfFloatAsFloatRGBAArrayBuffer(N,B,i.byteOffset+H,V,i.buffer,o))),r.type=0;else{let e=$.textureFloat&&(p&&$.textureFloatLinearFiltering||!p),t=$.textureHalfFloat&&(p&&$.textureHalfFloatLinearFiltering||!p),s=(J===128||J===64&&!t)&&e?1:(J===64||J===128&&!e)&&t?2:0,c,l=null;switch(J){case 128:switch(s){case 1:c=n._GetFloatRGBAArrayBuffer,l=null;break;case 2:c=n._GetFloatAsHalfFloatRGBAArrayBuffer,l=n._GetFloatRGBAArrayBuffer;break;case 0:c=n._GetFloatAsUIntRGBAArrayBuffer,l=n._GetFloatRGBAArrayBuffer;break}break;default:switch(s){case 1:c=n._GetHalfFloatAsFloatRGBAArrayBuffer,l=null;break;case 2:c=n._GetHalfFloatRGBAArrayBuffer,l=n._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:c=n._GetHalfFloatAsUIntRGBAArrayBuffer,l=n._GetHalfFloatAsFloatRGBAArrayBuffer;break}break}r.type=s,a=c(N,B,i.byteOffset+H,V,i.buffer,o),m&&o==0&&m.push(l?l(N,B,i.byteOffset+H,V,i.buffer,o):a)}a&&t._uploadDataToTextureDirectly(r,a,e,o)}else if(a.isRGB)r.type=0,J===24?(r.format=4,V=N*B*3,U=n._GetRGBArrayBuffer(N,B,i.byteOffset+H,V,i.buffer,X,Z,Q),t._uploadDataToTextureDirectly(r,U,e,o)):(r.format=5,V=N*B*4,U=n._GetRGBAArrayBuffer(N,B,i.byteOffset+H,V,i.buffer,X,Z,Q,ne),t._uploadDataToTextureDirectly(r,U,e,o));else if(a.isLuminance){let a=t._getUnpackAlignement(),s=N,c=Math.floor((N+a-1)/a)*a;V=c*(B-1)+s,U=n._GetLuminanceArrayBuffer(N,B,i.byteOffset+H,V,i.buffer),r.format=1,r.type=0,t._uploadDataToTextureDirectly(r,U,e,o)}else V=Math.max(4,N)/4*Math.max(4,B)/4*q,U=new Uint8Array(i.buffer,i.byteOffset+H,V),r.type=0,t._uploadCompressedDataToTextureDirectly(r,K,N,B,U,e,o)}H+=J?N*B*(J/8):V,N*=.5,B*=.5,N=Math.max(1,N),B=Math.max(1,B)}if(u!==void 0)break}m&&m.length>0?a.sphericalPolynomial=l.ConvertCubeMapToSphericalPolynomial({size:g[j],right:m[0],left:m[1],up:m[2],down:m[3],front:m[4],back:m[5],format:5,type:1,gammaSpace:!1}):a.sphericalPolynomial=void 0}};H.StoreLODInAlphaChannel=!1;export{H as b};