import{c as e,d as t,e as n}from"./webAudioBaseSubGraph-CYcHX6iU.js";import{b as r,d as i,f as a,g as o}from"./spatialWebAudio-BAmtw0U_.js";import{b as s,c}from"./abstractSoundInstance-BcAyeUyt.js";var l=class extends c{constructor(e,t){super(e,t)}get duration(){return this._options.duration}set duration(e){this._options.duration=e}get loopStart(){return this._options.loopStart}set loopStart(e){this._options.loopStart=e}get loopEnd(){return this._options.loopEnd}set loopEnd(e){this._options.loopEnd=e}get pitch(){return this._options.pitch}set pitch(e){this._options.pitch=e;let t=this._instances.values();for(let n=t.next();!n.done;n=t.next())n.value.pitch=e}get playbackRate(){return this._options.playbackRate}set playbackRate(e){this._options.playbackRate=e;let t=this._instances.values();for(let n=t.next();!n.done;n=t.next())n.value.playbackRate=e}play(e={}){if(this.state===5){this.resume();return}e.duration??=this.duration,e.loop??=this.loop,e.loopStart??=this.loopStart,e.loopEnd??=this.loopEnd,e.startOffset??=this.startOffset,e.volume??=1,e.waitTime??=0;let t=this._createInstance();this._beforePlay(t),t.play(e),this._afterPlay(t),this._stopExcessInstances()}stop(e={}){if(e.waitTime&&0<e.waitTime?this._setState(0):this._setState(1),this._instances)for(let t of Array.from(this._instances))t.stop(e)}};let u=1;var d=class{constructor(e){this.name=`StaticSoundBuffer #${u++}`,this.engine=e}},f=class extends s{},p=class e extends l{constructor(t,n,r){super(t,n),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,typeof r.spatialAutoUpdate==`boolean`&&(this._spatialAutoUpdate=r.spatialAutoUpdate),typeof r.spatialMinUpdateTime==`number`&&(this._spatialMinUpdateTime=r.spatialMinUpdateTime),this._options={autoplay:r.autoplay??!1,duration:r.duration??0,loop:r.loop??!1,loopEnd:r.loopEnd??0,loopStart:r.loopStart??0,maxInstances:r.maxInstances??1/0,pitch:r.pitch??0,playbackRate:r.playbackRate??1,startOffset:r.startOffset??0},this._subGraph=new e._SubGraph(this)}async _initAsync(e,t){this._audioContext=this.engine._audioContext,e instanceof m?this._buffer=e:(typeof e==`string`||Array.isArray(e)||e instanceof ArrayBuffer||e instanceof AudioBuffer)&&(this._buffer=await this.engine.createSoundBufferAsync(e,t)),t.outBus?this.outBus=t.outBus:t.outBusAutoDefault!==!1&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(t),o(t)&&this._initSpatialProperty(),t.autoplay&&this.play(),this.engine._addNode(this)}get buffer(){return this._buffer}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??=new a(this._subGraph)}async cloneAsync(e=null){let t=await this.engine.createSoundAsync(this.name,e?.cloneBuffer?this.buffer.clone():this.buffer,this._options);return t.outBus=e?.outBus?e.outBus:this.outBus,t}dispose(){super.dispose(),this._spatial?.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this)}getClassName(){return`_WebAudioStaticSound`}_createInstance(){return new h(this,this._options)}_connect(e){let t=super._connect(e);return t?(e._inNode&&this._outNode?.connect(e._inNode),!0):!1}_disconnect(e){let t=super._disconnect(e);return t?(e._inNode&&this._outNode?.disconnect(e._inNode),!0):!1}_initSpatialProperty(){return this._spatial||=new r(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime),this._spatial}};p._SubGraph=class extends i{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};var m=class e extends d{constructor(e){super(e)}async _initAsync(e,t){e instanceof AudioBuffer?this._audioBuffer=e:typeof e==`string`?await this._initFromUrlAsync(e):Array.isArray(e)?await this._initFromUrlsAsync(e,t.skipCodecCheck??!1):e instanceof ArrayBuffer&&await this._initFromArrayBufferAsync(e)}get channelCount(){return this._audioBuffer.numberOfChannels}get duration(){return this._audioBuffer.duration}get length(){return this._audioBuffer.length}get sampleRate(){return this._audioBuffer.sampleRate}clone(t=null){let n=new AudioBuffer({length:this._audioBuffer.length,numberOfChannels:this._audioBuffer.numberOfChannels,sampleRate:this._audioBuffer.sampleRate});for(let e=0;e<this._audioBuffer.numberOfChannels;e++)n.copyToChannel(this._audioBuffer.getChannelData(e),e);let r=new e(this.engine);return r._audioBuffer=n,r.name=t?.name?t.name:this.name,r}async _initFromArrayBufferAsync(e){this._audioBuffer=await this.engine._audioContext.decodeAudioData(e)}async _initFromUrlAsync(e){e=t(e),await this._initFromArrayBufferAsync(await(await fetch(e)).arrayBuffer())}async _initFromUrlsAsync(e,t){for(let r of e){if(t)await this._initFromUrlAsync(r);else{let e=r.match(n),t=e?.at(1);if(t&&this.engine.isFormatValid(t))try{await this._initFromUrlAsync(r)}catch{t&&0<t.length&&this.engine.flagInvalidFormat(t)}}if(this._audioBuffer)break}}},h=class extends f{constructor(e,t){super(e),this._enginePlayTime=0,this._enginePauseTime=0,this._isConnected=!1,this._pitch=null,this._playbackRate=null,this._sourceNode=null,this._onEnded=()=>{this._enginePlayTime=0,this.onEndedObservable.notifyObservers(this),this._deinitSourceNode()},this._onEngineStateChanged=()=>{this.engine.state===`running`&&(this._options.loop&&this.state===2&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged))},this._options=t,this._volumeNode=new GainNode(e._audioContext),this._initSourceNode()}dispose(){super.dispose(),this._pitch?.dispose(),this._playbackRate?.dispose(),this._sourceNode=null,this.stop(),this._deinitSourceNode(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}get currentTime(){if(this._state===1)return 0;let e=this._state===5?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+e+this._options.startOffset}set currentTime(e){let t=this._state===2||this._state===3;t&&(this.stop(),this._deinitSourceNode()),this._options.startOffset=e,t&&this.play()}get _outNode(){return this._volumeNode}set pitch(e){this._pitch?.setTargetValue(e)}set playbackRate(e){this._playbackRate?.setTargetValue(e)}get startTime(){return this._state===1?0:this._enginePlayTime}getClassName(){return`_WebAudioStaticSoundInstance`}play(e={}){if(this._state===3)return;e.duration!==void 0&&(this._options.duration=e.duration),e.loop!==void 0&&(this._options.loop=e.loop),e.loopStart!==void 0&&(this._options.loopStart=e.loopStart),e.loopEnd!==void 0&&(this._options.loopEnd=e.loopEnd),e.startOffset!==void 0&&(this._options.startOffset=e.startOffset);let t=this._options.startOffset;this._state===5&&(t+=this.currentTime,t%=this._sound.buffer.duration),this._enginePlayTime=this.engine.currentTime+(e.waitTime??0),this._volumeNode.gain.value=e.volume??1,this._initSourceNode(),this.engine.state===`running`?(this._setState(3),this._sourceNode?.start(this._enginePlayTime,t,this._options.duration>0?this._options.duration:void 0)):this._options.loop&&(this._setState(2),this.engine.stateChangedObservable.add(this._onEngineStateChanged))}pause(){this._state!==5&&(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._sourceNode?.stop(),this._deinitSourceNode())}resume(){this._state===5&&this.play()}stop(e={}){if(this._state===1)return;this._setState(1);let t=this.engine.currentTime+(e.waitTime??0);this._sourceNode?.stop(t),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}_connect(e){let t=super._connect(e);return t?(e instanceof p&&e._inNode&&(this._outNode?.connect(e._inNode),this._isConnected=!0),!0):!1}_disconnect(e){let t=super._disconnect(e);return t?(e instanceof p&&e._inNode&&(this._outNode?.disconnect(e._inNode),this._isConnected=!1),!0):!1}_deinitSourceNode(){if(this._sourceNode){if(this._isConnected&&!this._disconnect(this._sound))throw Error(`Disconnect failed`);this._sourceNode.disconnect(this._volumeNode),this._sourceNode.removeEventListener(`ended`,this._onEnded),this._sourceNode=null}}_initSourceNode(){if(!this._sourceNode){if(this._sourceNode=new AudioBufferSourceNode(this._sound._audioContext,{buffer:this._sound.buffer._audioBuffer}),this._sourceNode.addEventListener(`ended`,this._onEnded,{once:!0}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound))throw Error(`Connect failed`);this._pitch=new e(this.engine,this._sourceNode.detune),this._playbackRate=new e(this.engine,this._sourceNode.playbackRate)}let t=this._sourceNode;t.detune.value=this._sound.pitch,t.loop=this._options.loop,t.loopEnd=this._options.loopEnd,t.loopStart=this._options.loopStart,t.playbackRate.value=this._sound.playbackRate}};export{p as b,m as c};