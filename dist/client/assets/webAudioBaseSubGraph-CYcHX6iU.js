import{c as e}from"./observable-8SYwW91n.js";import{b as t}from"./logger-D2dXBhXY.js";var n;(function(e){e[e.HAS_INPUTS=1]=`HAS_INPUTS`,e[e.HAS_OUTPUTS=2]=`HAS_OUTPUTS`,e[e.HAS_INPUTS_AND_OUTPUTS=3]=`HAS_INPUTS_AND_OUTPUTS`})(n||={});var r=class{constructor(t,n){this.onDisposeObservable=new e,this.engine=t,n&1&&(this._upstreamNodes=new Set),n&2&&(this._downstreamNodes=new Set)}dispose(){if(this._downstreamNodes){for(let e of Array.from(this._downstreamNodes))if(!this._disconnect(e))throw Error(`Disconnect failed`);this._downstreamNodes.clear()}if(this._upstreamNodes){for(let e of Array.from(this._upstreamNodes))if(!e._disconnect(this))throw Error(`Disconnect failed`);this._upstreamNodes.clear()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}_connect(e){return!this._downstreamNodes||this._downstreamNodes.has(e)||!e._onConnect(this)?!1:(this._downstreamNodes.add(e),!0)}_disconnect(e){return!this._downstreamNodes||!this._downstreamNodes.delete(e)?!1:e._onDisconnect(this)}_onConnect(e){return!this._upstreamNodes||this._upstreamNodes.has(e)?!1:(this._upstreamNodes.add(e),!0)}_onDisconnect(e){return this._upstreamNodes?.delete(e)??!1}},i=class extends r{constructor(t,n,r){super(n,r),this.onNameChangedObservable=new e,this._name=t}get name(){return this._name}set name(e){if(this._name===e)return;let t=this._name;this._name=e,this.onNameChangedObservable.notifyObservers({newName:e,oldName:t,node:this})}dispose(){super.dispose(),this.onNameChangedObservable.clear()}},a=class extends i{constructor(e,t){super(e,t,3)}connect(e){if(!this._connect(e))throw Error(`Connect failed`)}disconnect(e){if(!this._disconnect(e))throw Error(`Disconnect failed`)}disconnectAll(){if(!this._downstreamNodes)throw Error(`Disconnect failed`);let e=this._downstreamNodes.values();for(let t=e.next();!t.done;t=e.next())if(!this._disconnect(t.value))throw Error(`Disconnect failed`)}};const o={volume:1};var s=class extends a{constructor(e){super(`Volume`,e)}setOptions(e){this.volume=e.volume??o.volume}};function c(e){return e.getSubNode(`Volume`)}function l(e,t){return c(e)?.[t]??o[t]}const u={fftSize:2048,minDecibels:-100,maxDecibels:-30,smoothing:.8};function d(e){return e.analyzerEnabled||e.analyzerFFTSize!==void 0||e.analyzerMinDecibels!==void 0||e.analyzerMaxDecibels!==void 0||e.analyzerSmoothing!==void 0}var f=class{get frequencyBinCount(){return this.fftSize/2}},p=class extends a{constructor(e){super(`Analyzer`,e)}setOptions(e){this.fftSize=e.analyzerFFTSize??u.fftSize,this.minDecibels=e.analyzerMinDecibels??u.minDecibels,this.maxDecibels=e.analyzerMaxDecibels??u.maxDecibels,this.smoothing=e.analyzerSmoothing??u.smoothing}};function m(e){return e.getSubNode(`Analyzer`)}function h(e,t,n){e.callOnSubNode(`Analyzer`,e=>{e[t]=n})}let g=null,_=null;function v(){return g||=new Uint8Array,g}function y(){return _||=new Float32Array,_}var b=class extends f{constructor(e){super(),this._fftSize=u.fftSize,this._maxDecibels=u.maxDecibels,this._minDecibels=u.minDecibels,this._smoothing=u.smoothing,this._subGraph=e}get fftSize(){return this._fftSize}set fftSize(e){this._fftSize=e,h(this._subGraph,`fftSize`,e)}get isEnabled(){return m(this._subGraph)!==null}get minDecibels(){return this._minDecibels}set minDecibels(e){this._minDecibels=e,h(this._subGraph,`minDecibels`,e)}get maxDecibels(){return this._maxDecibels}set maxDecibels(e){this._maxDecibels=e,h(this._subGraph,`maxDecibels`,e)}get smoothing(){return this._smoothing}set smoothing(e){this._smoothing=e,h(this._subGraph,`smoothing`,e)}dispose(){let e=m(this._subGraph);e&&(this._subGraph.removeSubNodeAsync(e),e.dispose())}async enableAsync(){let e=m(this._subGraph);e||await this._subGraph.createAndAddSubNodeAsync(`Analyzer`)}getByteFrequencyData(){let e=m(this._subGraph);return e?e.getByteFrequencyData():(t.Warn(`AudioAnalyzer not enabled`),this.enableAsync(),v())}getFloatFrequencyData(){let e=m(this._subGraph);return e?e.getFloatFrequencyData():(t.Warn(`AudioAnalyzer not enabled`),this.enableAsync(),y())}},x=class extends i{constructor(e,t,n){super(e,t,n),this._analyzer=null}get analyzer(){return this._analyzer??=new b(this._subGraph)}get volume(){return l(this._subGraph,`volume`)}set volume(e){let t=c(this._subGraph);if(!t)throw Error(`No volume subnode`);t.volume=e}dispose(){super.dispose(),this._analyzer?.dispose(),this._analyzer=null,this._subGraph.dispose()}setVolume(e,t=null){let n=c(this._subGraph);if(!n)throw Error(`No volume subnode`);n.setVolume(e,t)}};const S=RegExp(`\\.(\\w{3,4})($|\\?)`),C=100,w=new Float32Array([0,0]);let T=null,E=null,D=null;function O(){if(!E){E=new Float32Array(C);let e=1/(C-1),t=e;for(let n=1;n<C;n++)E[n]=Math.exp(-11.512925464970227*(1-t)),t+=e}return E}function k(){if(!D){D=new Float32Array(C);let e=1/C,t=e;for(let n=0;n<C;n++)D[n]=1+Math.log10(t)/Math.log10(C),t+=e}return D}function A(e,t,n){T||=new Float32Array(C);let r;if(e===`linear`)return w[0]=t,w[1]=n,w;if(e===`exponential`)r=O();else if(e===`logarithmic`)r=k();else throw Error(`Unknown ramp shape: ${e}`);let i=Math.sign(n-t),a=Math.abs(n-t);if(i===1)for(let e=0;e<r.length;e++)T[e]=t+a*r[e];else{let e=C-1;for(let n=0;n<r.length;n++,e--)T[n]=t-a*(1-r[e])}return T}function j(e){return e.replace(/#/gm,`%23`)}const M=.011,N=1e-6;var P=class{constructor(e,t){this._deferredRampOptions={duration:0,shape:`linear`},this._deferredTargetValue=-1,this._isObservingUpdates=!1,this._rampEndTime=0,this._applyDeferredRamp=()=>{0<this._deferredRampOptions.duration&&this._rampEndTime<this._engine.currentTime&&this.setTargetValue(this._deferredTargetValue,this._deferredRampOptions)},this._engine=e,this._param=t,this._targetValue=t.value}get isRamping(){return this._engine.currentTime<this._rampEndTime}get targetValue(){return this._targetValue}set targetValue(e){this.setTargetValue(e)}get value(){return this._param.value}dispose(){this._clearDeferredRamp(),this._param=null,this._engine=null}setTargetValue(e,t=null){if(this._targetValue===e)return;let n=typeof t?.shape==`string`?t.shape:`linear`,r=typeof t?.duration==`number`?Math.max(t.duration,this._engine.parameterRampDuration):this._engine.parameterRampDuration,i=this._engine.currentTime;if(i<this._rampEndTime){let t=this._rampEndTime-i;if(M<t)throw Error(`Audio parameter not set. Wait for current ramp to finish.`);this._deferRamp(e,r,n);return}if((r=Math.max(this._engine.parameterRampDuration,r))<N){this._param.setValueAtTime(this._targetValue=e,i);return}this._param.cancelScheduledValues(i),this._param.setValueCurveAtTime(A(n,this._targetValue,this._targetValue=e),i,r),this._clearDeferredRamp(),this._rampEndTime=i+r}_deferRamp(e,t,n){this._deferredRampOptions.duration=t,this._deferredRampOptions.shape=n,this._deferredTargetValue=e,this._isObservingUpdates||(this._engine._addUpdateObserver(this._applyDeferredRamp),this._isObservingUpdates=!0)}_clearDeferredRamp(){this._deferredRampOptions.duration=0,this._isObservingUpdates&&(this._engine._removeUpdateObserver(this._applyDeferredRamp),this._isObservingUpdates=!1)}},F=class{constructor(){this._createSubNodePromises={},this._isDisposed=!1,this._subNodes={},this._onSubNodeDisposed=e=>{let t=e;delete this._subNodes[t.name],this._onSubNodesChanged()}}callOnSubNode(e,t){let n=this.getSubNode(e);if(n){t(n);return}this._createSubNodePromisesResolvedAsync().then(()=>{let n=this.getSubNode(e);if(n){t(n);return}this.createAndAddSubNodeAsync(e).then(e=>{t(e)})})}createAndAddSubNodeAsync(e){var t;return(t=this._createSubNodePromises)[e]||(t[e]=this._createSubNode(e).then(e=>(this._addSubNode(e),e))),this._createSubNodePromises[e]}dispose(){this._isDisposed=!0;let e=Object.values(this._subNodes);for(let t of e)t.dispose();this._subNodes={},this._createSubNodePromises={}}getSubNode(e){return this._subNodes[e]??null}async removeSubNodeAsync(e){await this._createSubNodePromisesResolvedAsync();let t=e.name;this._subNodes[t]&&delete this._subNodes[t],delete this._createSubNodePromises[t],this._onSubNodesChanged()}async _createSubNodePromisesResolvedAsync(){return await Promise.all(Object.values(this._createSubNodePromises))}_addSubNode(e){if(this._isDisposed){e.dispose();return}this._subNodes[e.name]=e,e.onDisposeObservable.addOnce(this._onSubNodeDisposed),this._onSubNodesChanged()}};async function I(e){return new L(e)}var L=class extends s{constructor(e){super(e);let t=this.node=new GainNode(e._audioContext);this._volume=new P(e,t.gain)}dispose(){super.dispose(),this._volume.dispose()}get volume(){return this._volume.value}set volume(e){this.setVolume(e)}get _inNode(){return this.node}get _outNode(){return this.node}setVolume(e,t=null){this._volume.setTargetValue(e,t)}_connect(e){let t=super._connect(e);return t?(e._inNode&&this.node.connect(e._inNode),!0):!1}_disconnect(e){let t=super._disconnect(e);return t?(e._inNode&&this.node.disconnect(e._inNode),!0):!1}getClassName(){return`_VolumeWebAudioSubNode`}};async function R(e){return new z(e)}var z=class extends p{constructor(e){super(e),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode=new AnalyserNode(e._audioContext)}get fftSize(){return this._analyzerNode.fftSize}set fftSize(e){e!==this._analyzerNode.fftSize&&(this._analyzerNode.fftSize=e,this._clearArrays())}get _inNode(){return this._analyzerNode}get minDecibels(){return this._analyzerNode.minDecibels}set minDecibels(e){this._analyzerNode.minDecibels=e}get maxDecibels(){return this._analyzerNode.maxDecibels}set maxDecibels(e){this._analyzerNode.maxDecibels=e}get smoothing(){return this._analyzerNode.smoothingTimeConstant}set smoothing(e){this._analyzerNode.smoothingTimeConstant=e}dispose(){super.dispose(),this._clearArrays(),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode.disconnect()}getClassName(){return`_WebAudioAnalyzerSubNode`}getByteFrequencyData(){return(!this._byteFrequencyData||this._byteFrequencyData.length===0)&&(this._byteFrequencyData=new Uint8Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getByteFrequencyData(this._byteFrequencyData),this._byteFrequencyData}getFloatFrequencyData(){return(!this._floatFrequencyData||this._floatFrequencyData.length===0)&&(this._floatFrequencyData=new Float32Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getFloatFrequencyData(this._floatFrequencyData),this._floatFrequencyData}_clearArrays(){this._byteFrequencyData?.set(v()),this._floatFrequencyData?.set(y())}},B=class extends F{constructor(e){super(),this._outputNode=null,this._owner=e}async initAsync(e){let t=d(e);if(t&&await this.createAndAddSubNodeAsync(`Analyzer`),await this.createAndAddSubNodeAsync(`Volume`),await this._createSubNodePromisesResolvedAsync(),t){let t=m(this);if(!t)throw Error(`No analyzer subnode.`);t.setOptions(e)}let n=c(this);if(!n)throw Error(`No volume subnode.`);if(n.setOptions(e),n.getClassName()!==`_VolumeWebAudioSubNode`)throw Error(`Not a WebAudio subnode.`);if(this._outputNode=n.node,this._outputNode&&this._downstreamNodes){let e=this._downstreamNodes.values();for(let t=e.next();!t.done;t=e.next()){let e=t.value._inNode;e&&this._outputNode.connect(e)}}}get _inNode(){return this._outputNode}get _outNode(){return this._outputNode}_createSubNode(e){switch(e){case`Analyzer`:return R(this._owner.engine);case`Volume`:return I(this._owner.engine);default:throw Error(`Unknown subnode name: ${e}`)}}_onSubNodesChanged(){let e=m(this),t=c(this);e&&t&&t.connect(e)}};export{B as b,P as c,j as d,S as e,x as f,c as g,a as h,r as i};