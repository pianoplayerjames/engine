const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/postprocess.vertex-kPaKVKIq.js","assets/shaderStore-e8RCqiF-.js","assets/postprocess.vertex-YM1Aw5hL.js","assets/postprocess.vertex-B4T4K4h9.js","assets/postprocess.vertex-CeYFzkdl.js"])))=>i.map(i=>d[i]);
import{b as e}from"./index-BSOJ-fS9.js";import{c as t}from"./observable-8SYwW91n.js";import{b as n}from"./logger-D2dXBhXY.js";import{m as r,z as i}from"./tools.functions-Cy84Um-0.js";import{b as a}from"./dataBuffer-BEUz_e_e.js";function o(e,t,n,r){switch(t){case 5120:{let t=e.getInt8(n);return r&&(t=Math.max(t/127,-1)),t}case 5121:{let t=e.getUint8(n);return r&&(t/=255),t}case 5122:{let t=e.getInt16(n,!0);return r&&(t=Math.max(t/32767,-1)),t}case 5123:{let t=e.getUint16(n,!0);return r&&(t/=65535),t}case 5124:return e.getInt32(n,!0);case 5125:return e.getUint32(n,!0);case 5126:return e.getFloat32(n,!0);default:throw Error(`Invalid component type ${t}`)}}function s(e,t,n,r,i){switch(t){case 5120:r&&(i=Math.round(i*127)),e.setInt8(n,i);break;case 5121:r&&(i=Math.round(i*255)),e.setUint8(n,i);break;case 5122:r&&(i=Math.round(i*32767)),e.setInt16(n,i,!0);break;case 5123:r&&(i=Math.round(i*65535)),e.setUint16(n,i,!0);break;case 5124:e.setInt32(n,i,!0);break;case 5125:e.setUint32(n,i,!0);break;case 5126:e.setFloat32(n,i,!0);break;default:throw Error(`Invalid component type ${t}`)}}function c(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:throw Error(`Invalid type '${e}'`)}}function l(e){switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw Error(`Invalid component type '${e}'`)}}function u(e,t,n,r,i,a,l,u){let d=Array(r),f=Array(r);if(e instanceof Array){let i=t/4,o=n/4;for(let t=0;t<a;t+=r){for(let t=0;t<r;t++)d[t]=f[t]=e[i+t];u(f,t);for(let t=0;t<r;t++)d[t]!==f[t]&&(e[i+t]=f[t]);i+=o}}else{let p=ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e),m=c(i);for(let e=0;e<a;e+=r){for(let e=0,n=t;e<r;e++,n+=m)d[e]=f[e]=o(p,i,n,l);u(f,e);for(let e=0,n=t;e<r;e++,n+=m)d[e]!==f[e]&&s(p,i,n,l,f[e]);t+=n}}}function d(e,t,r,i,a,o,s,l){let d=t*c(r),f=s*t;if(r!==5126||a!==d){let n=new Float32Array(f);return u(e,i,a,t,r,f,o,(e,r)=>{for(let i=0;i<t;i++)n[r+i]=e[i]}),n}if(!(e instanceof Array||e instanceof Float32Array)||i!==0||e.length!==f)if(e instanceof Array){let t=i/4;return e.slice(t,t+f)}else if(e instanceof ArrayBuffer)return new Float32Array(e,i,f);else{let t=e.byteOffset+i;return t&3&&(n.Warn(`Float array must be aligned to 4-bytes border`),l=!0),l?new Float32Array(e.buffer.slice(t,t+f*Float32Array.BYTES_PER_ELEMENT)):new Float32Array(e.buffer,t,f)}return l?e.slice():e}function f(e,t,r,i,a,o,s,d){let f=c(r),p=l(r),m=s*t;if(Array.isArray(e)){if(i&3||a&3)throw Error(`byteOffset and byteStride must be a multiple of 4 for number[] data.`);let n=i/4,c=a/4,l=n+(s-1)*c+t;if(l>e.length)throw Error(`Last accessed index is out of bounds.`);if(c<t)throw Error(`Data stride cannot be smaller than the component size.`);if(c!==t){let n=new p(m);return u(e,i,a,t,r,m,o,(e,r)=>{for(let i=0;i<t;i++)n[r+i]=e[i]}),n}return new p(e.slice(n,n+m))}let h,g=i;e instanceof ArrayBuffer?h=e:(h=e.buffer,g+=e.byteOffset);let _=g+(s-1)*a+t*f;if(_>h.byteLength)throw Error(`Last accessed byte is out of bounds.`);let v=t*f;if(a<v)throw Error(`Byte stride cannot be smaller than the component's byte size.`);if(a!==v){let e=new p(m);return u(h,g,a,t,r,m,o,(n,r)=>{for(let i=0;i<t;i++)e[r+i]=n[i]}),e}return f!==1&&g&f-1&&(n.Warn(`Array must be aligned to border of element size. Data will be copied.`),d=!0),d?new p(h.slice(g,g+m*f)):new p(h,g,m)}function p(e,t,r,i,a,o,s,l){let d=t*c(r),f=s*t;if(l.length!==f)throw Error(`Output length is not valid`);if(r!==5126||a!==d){u(e,i,a,t,r,f,o,(e,n)=>{for(let r=0;r<t;r++)l[n+r]=e[r]});return}if(e instanceof Array){let t=i/4;l.set(e,t)}else if(e instanceof ArrayBuffer){let t=new Float32Array(e,i,f);l.set(t)}else{let t=e.byteOffset+i;if(t&3){n.Warn(`Float array must be aligned to 4-bytes border`),l.set(new Float32Array(e.buffer.slice(t,t+f*Float32Array.BYTES_PER_ELEMENT)));return}let r=new Float32Array(e.buffer,t,f);l.set(r)}}function m(e,t,n=0,r=0){if(Array.isArray(e)){for(let i=0;i<t;i++)if(e[n+i]-r>65535)return!0;return!1}return e.BYTES_PER_ELEMENT===4}var h=class{get isDisposed(){return this._isDisposed}constructor(e,t,n,r=0,i=!1,o=!1,s=!1,c,l){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=n,this._instanced=o,this._divisor=c||1,this._label=l,t instanceof a?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=s?r:r*Float32Array.BYTES_PER_ELEMENT,i||this.create()}createVertexBuffer(e,t,n,r,i,a=!1,o){let s=a?t:t*Float32Array.BYTES_PER_ELEMENT,c=r?a?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new g(this._engine,this,e,this._updatable,!0,c,i===void 0?this._instanced:i,s,n,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e||=this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label)))}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else{if(!this._buffer)return;if(this._buffer.capacity>0){this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label);return}n.Warn(`Missing data for buffer "${this._label}" ${this._buffer?`(uniqueId: `+this._buffer.uniqueId+`)`:``}. Buffer reconstruction failed.`),this._buffer=null}}update(e){this.create(e)}updateDirectly(e,t,n,r=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*Float32Array.BYTES_PER_ELEMENT,n?n*this.byteStride:void 0),t===0&&n===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}},g=class e{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){let t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get _maxVerticesCount(){let e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(t,n,r,i,a,o,s,l,u,d,f=!1,p=!1,m=1,g=!1){this._isDisposed=!1;let _=!1;if(this.engine=t,typeof i==`object`&&i?(_=i.updatable??!1,a=i.postponeInternalCreation,o=i.stride,s=i.instanced,l=i.offset,u=i.size,d=i.type,f=i.normalized??!1,p=i.useBytes??!1,m=i.divisor??1,g=i.takeBufferOwnership??!1,this._label=i.label):_=!!i,n instanceof h?(this._buffer=n,this._ownsBuffer=g):(this._buffer=new h(t,n,_,o,a,s,p,m,this._label),this._ownsBuffer=!0),this.uniqueId=e._Counter++,this._kind=r,d===void 0){let t=this.getData();this.type=t?e.GetDataType(t):e.FLOAT}else this.type=d;let v=c(this.type);p?(this._size=u||(o?o/v:e.DeduceStride(r)),this.byteStride=o||this._buffer.byteStride||this._size*v,this.byteOffset=l||0):(this._size=u||o||e.DeduceStride(r),this.byteStride=o?o*v:this._buffer.byteStride||this._size*v,this.byteOffset=(l||0)*v),this.normalized=f,this._instanced=s===void 0?!1:s,this._instanceDivisor=s?m:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer?._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){let n=this.getData();return n?d(n,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/c(this.type)}getOffset(){return this.byteOffset/c(this.type)}getSize(e=!1){return e?this._size*c(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,n=!1){this._buffer.updateDirectly(e,t,void 0,n),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){u(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,(e,n)=>{for(let r=0;r<this._size;r++)t(e[r],n+r)})}_alignBuffer(){}static DeduceStride(t){switch(t){case e.UVKind:case e.UV2Kind:case e.UV3Kind:case e.UV4Kind:case e.UV5Kind:case e.UV6Kind:return 2;case e.NormalKind:case e.PositionKind:return 3;case e.ColorKind:case e.ColorInstanceKind:case e.MatricesIndicesKind:case e.MatricesIndicesExtraKind:case e.MatricesWeightsKind:case e.MatricesWeightsExtraKind:case e.TangentKind:return 4;default:throw Error(`Invalid kind '`+t+`'`)}}static GetDataType(t){return t instanceof Int8Array?e.BYTE:t instanceof Uint8Array?e.UNSIGNED_BYTE:t instanceof Int16Array?e.SHORT:t instanceof Uint16Array?e.UNSIGNED_SHORT:t instanceof Int32Array?e.INT:t instanceof Uint32Array?e.UNSIGNED_INT:e.FLOAT}static GetTypeByteLength(e){return c(e)}static ForEach(e,t,n,r,i,a,o,s){u(e,t,n,r,i,a,o,(e,t)=>{for(let n=0;n<r;n++)s(e[n],t+n)})}static GetFloatData(e,t,n,r,i,a,o,s){return d(e,t,n,r,i,a,o,s)}};g._Counter=0,g.BYTE=5120,g.UNSIGNED_BYTE=5121,g.SHORT=5122,g.UNSIGNED_SHORT=5123,g.INT=5124,g.UNSIGNED_INT=5125,g.FLOAT=5126,g.PositionKind=`position`,g.NormalKind=`normal`,g.TangentKind=`tangent`,g.UVKind=`uv`,g.UV2Kind=`uv2`,g.UV3Kind=`uv3`,g.UV4Kind=`uv4`,g.UV5Kind=`uv5`,g.UV6Kind=`uv6`,g.ColorKind=`color`,g.ColorInstanceKind=`instanceColor`,g.MatricesIndicesKind=`matricesIndices`,g.MatricesWeightsKind=`matricesWeights`,g.MatricesIndicesExtraKind=`matricesIndicesExtra`,g.MatricesWeightsExtraKind=`matricesWeightsExtra`;var _=class e{constructor(e,t,n,r){this.x=e,this.y=t,this.width=n,this.height=r}toGlobal(t,n){return new e(this.x*t,this.y*n,this.width*t,this.height*n)}toGlobalToRef(e,t,n){return n.x=this.x*e,n.y=this.y*t,n.width=this.width*e,n.height=this.height*t,this}clone(){return new e(this.x,this.y,this.width,this.height)}},v=class{static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!0,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,n=!0){this.effect=e,t!==void 0&&(this.defines=t),n&&this.drawContext?.reset()}dispose(e=!1){if(this.effect){let t=this.effect;e?t.dispose():i.SetImmediate(()=>{t.getEngine().onEndFrameObservable.addOnce(()=>{t.dispose()})}),this.effect=null}this.drawContext?.dispose()}};const y={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};var b=class{constructor(e,t=y){this._fullscreenViewport=new _(0,0,1,1);let n=t.positions??y.positions,r=t.indices??y.indices;this.engine=e,this._vertexBuffers={[g.PositionKind]:new g(e,n,g.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(r),this._indexBufferLength=r.length,this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{for(let t in this._indexBuffer=e.createIndexBuffer(r),this._vertexBuffers){let e=this._vertexBuffers[t];e._rebuild()}})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e.drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();let n=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;n&&this.engine.bindFramebuffer(n),this.applyEffectWrapper(e),this.draw(),n&&this.engine.unBindFramebuffer(n),this.restoreStates()}dispose(){let e=this._vertexBuffers[g.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[g.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}},x=class n{static RegisterShaderCodeProcessing(e,t){if(!t){delete n._CustomShaderCodeProcessing[e??``];return}n._CustomShaderCodeProcessing[e??``]=t}static _GetShaderCodeProcessing(e){return n._CustomShaderCodeProcessing[e]??n._CustomShaderCodeProcessing[``]}get name(){return this.options.name}set name(e){this.options.name=e}isReady(){return this._drawWrapper.effect?.isReady()??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.alphaMode=0,this.onEffectCreatedObservable=new t(void 0,!0),this.onApplyObservable=new t,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...e,name:e.name||`effectWrapper`,engine:e.engine,uniforms:e.uniforms||e.uniformNames||[],uniformNames:void 0,samplers:e.samplers||e.samplerNames||[],samplerNames:void 0,attributeNames:e.attributeNames||[`position`],uniformBuffers:e.uniformBuffers||[],defines:e.defines||``,useShaderStore:e.useShaderStore||!1,vertexUrl:e.vertexUrl||e.vertexShader||`postprocess`,vertexShader:void 0,fragmentShader:e.fragmentShader||`pass`,indexParameters:e.indexParameters,blockCompilation:e.blockCompilation||!1,shaderLanguage:e.shaderLanguage||0,onCompiled:e.onCompiled||void 0,extraInitializations:e.extraInitializations||void 0,extraInitializationsAsync:e.extraInitializationsAsync||void 0,useAsPostProcess:e.useAsPostProcess??!1,allowEmptySourceTexture:e.allowEmptySourceTexture??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(!this.options.allowEmptySourceTexture&&this.options.samplers.indexOf(`textureSampler`)===-1&&this.options.samplers.push(`textureSampler`),this.options.uniforms.indexOf(`scale`)===-1&&this.options.uniforms.push(`scale`)),e.vertexUrl||e.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push(`scale`),this.onApplyObservable.add(()=>{this.effect.setFloat2(`scale`,1,1)})),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add(()=>{this.bind()}),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()})),this._drawWrapper=new v(this.options.engine),this._webGPUReady=this.options.shaderLanguage===1;let n=Array.isArray(this.options.defines)?this.options.defines.join(`
`):this.options.defines;this._postConstructor(this.options.blockCompilation,n,this.options.extraInitializations)}_gatherImports(t=!1,n){this.options.useAsPostProcess&&(t&&this._webGPUReady?n.push(Promise.all([e(()=>import(`./postprocess.vertex-kPaKVKIq.js`),__vite__mapDeps([0,1,2]))])):n.push(Promise.all([e(()=>import(`./postprocess.vertex-B4T4K4h9.js`),__vite__mapDeps([3,1,4]))])))}_postConstructor(e,t=null,r,i){this._importPromises.length=0,i&&this._importPromises.push(...i);let a=this.options.engine.isWebGPU&&!n.ForceGLSL;this._gatherImports(a,this._importPromises),r!==void 0&&r(a,this._importPromises),a&&this._webGPUReady&&(this.options.shaderLanguage=1),e||this.updateEffect(t)}updateEffect(e=null,t=null,i=null,a,o,s,c,l){let u=n._GetShaderCodeProcessing(this.name);if(u?.defineCustomBindings){let n=t?.slice()??[];n.push(...this.options.uniforms);let r=i?.slice()??[];r.push(...this.options.samplers),e=u.defineCustomBindings(this.name,e,n,r),t=n,i=r}this.options.defines=e||``;let d=this._shadersLoaded||this._importPromises.length===0?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0},f;f=this.options.extraInitializationsAsync?async()=>{d?.(),await this.options.extraInitializationsAsync()}:d,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({vertex:c??this._shaderPath.vertex,fragment:l??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:t||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:i||this.options.samplers,defines:e===null?``:e,fallbacks:null,onCompiled:o??this.options.onCompiled,onError:s??null,indexParameters:a||this.options.indexParameters,processCodeAfterIncludes:u?.processCodeAfterIncludes?(e,t)=>u.processCodeAfterIncludes(this.name,e,t):null,processFinalCode:u?.processFinalCode?(e,t)=>u.processFinalCode(this.name,e,t):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:f},this.options.engine):this._drawWrapper.effect=new r(this._shaderPath,this.options.attributeNames,t||this.options.uniforms,i||this.options.samplerNames,this.options.engine,e,void 0,o||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,f),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(e=!1){this.options.useAsPostProcess&&!e&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2(`scale`,1,1)),n._GetShaderCodeProcessing(this.name)?.bindCustomBindings?.(this.name,this._drawWrapper.effect)}dispose(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}};x.ForceGLSL=!1,x._CustomShaderCodeProcessing={};export{b,x as c,v as d,_ as e,h as f,g,m as h,p as i,c as j,f as k};